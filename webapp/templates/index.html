<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ALE Log Analyzer</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üÖ∞Ô∏è</text></svg>">
    <script src="{{ url_for('static', filename='chart.min.js') }}"></script>
    <style>
        body { font-family: Arial; max-width: 800px; margin: 50px auto; padding: 20px; }
        #dropzone { border: 3px dashed #ccc; padding: 50px; text-align: center; margin: 20px 0; cursor: pointer; transition: all 0.3s; }
        #dropzone:hover { border-color: #666; background: #fafafa; }
        #dropzone.hover { border-color: #333; background: #f0f0f0; }
        .file-info { background: #f9f9f9; padding: 15px; margin: 10px 0; border-left: 4px solid #4CAF50; position: relative; }
        .file-info.status-pass { border-left-color: #4CAF50; }
        .file-info.status-fail { border-left-color: #f44336; }
        .file-info.status-unknown { border-left-color: #FF9800; }
        .upload-time { 
            position: absolute; 
            top: 10px; 
            right: 15px; 
            font-size: 0.75em; 
            color: #666; 
            text-align: right;
            line-height: 1.4;
        }
        .download-btn { background: #4CAF50; color: white; padding: 10px 20px; border: none; cursor: pointer; margin: 5px; border-radius: 4px; }
        .download-btn:hover { background: #45a049; }
        .clear-btn { background: #f44336; color: white; padding: 8px 16px; border: none; cursor: pointer; margin: 5px; border-radius: 4px; }
        .clear-btn:hover { background: #da190b; }
        pre { background: #f4f4f4; padding: 10px; overflow-x: auto; }
        .button-group { margin-top: 10px; }
        .control-panel { margin: 20px 0; text-align: center; }
        .control-btn { background: #2196F3; color: white; padding: 10px 20px; border: none; cursor: pointer; margin: 0 5px; border-radius: 4px; }
        .control-btn:hover { background: #0b7dda; }
        .file-content { overflow: hidden; transition: max-height 0.3s ease; }
        .file-content.collapsed { max-height: 0; }
        .file-content.expanded { max-height: 5000px; }
        .file-header { cursor: pointer; user-select: none; }
        .file-header:hover { background: #f0f0f0; }
        .toggle-icon { display: inline-block; margin-right: 5px; transition: transform 0.3s; }
        .toggle-icon.collapsed { transform: rotate(-90deg); }
        .fail-count { color: #f44336; font-weight: bold; margin-left: 10px; font-size: 0.9em; }
        .test-summary { background: #e3f2fd; padding: 10px; margin: 10px 0; border-radius: 4px; font-size: 0.9em; }
        .test-summary strong { color: #1976D2; }
        .fail-item { background: #ffebee; padding: 10px; margin: 5px 0; border-left: 3px solid #f44336; }
        .fail-item strong { color: #c62828; }
        .temp-badge { color: white; padding: 2px 8px; border-radius: 3px; font-size: 0.85em; }
        .temp-cold { background: #2196F3; }
        .temp-normal { background: #4CAF50; }
        .temp-hot { background: #ff5722; }
        .copy-btn { background: #607D8B; color: white; padding: 4px 12px; border: none; cursor: pointer; border-radius: 3px; font-size: 0.85em; margin-left: 10px; }
        .copy-btn:hover { background: #455A64; }
        .copy-btn.copied { background: #4CAF50; }
        .help-icon { 
            display: inline-block;
            width: 18px;
            height: 18px;
            background: #2196F3;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 18px;
            font-size: 0.8em;
            margin-left: 8px;
            cursor: help;
            font-weight: bold;
        }
        .help-icon:hover { 
            background: #1976D2;
            cursor: none;
        }
        .snapshot-help-icon {
            display: inline-block;
            width: 22px;
            height: 22px;
            background: #2196F3;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 22px;
            font-size: 0.9em;
            margin-left: 8px;
            cursor: help;
            font-weight: bold;
        }
        .snapshot-help-icon:hover { 
            background: #1976D2;
        }
        .snapshot-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #9C27B0;
            color: white;
            padding: 15px 25px;
            border: none;
            cursor: pointer;
            border-radius: 50px;
            font-size: 1em;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            z-index: 1000;
            transition: all 0.3s;
        }
        .snapshot-btn:hover {
            background: #7B1FA2;
            transform: scale(1.05);
        }
        .snapshot-btn .btn-icon {
            display: none;
        }
        
        /* Áï∂Ëû¢ÂπïÂØ¨Â∫¶Â∞èÊñº 1082px ÊôÇ,Âè™È°ØÁ§∫ÂúìÂΩ¢ÂúñÊ®ô */
        @media (max-width: 1082px) {
            .snapshot-btn {
                width: 50px;
                height: 50px;
                padding: 0;
                border-radius: 50%;
                font-size: 1.5em;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .snapshot-btn .btn-text,
            .snapshot-btn .snapshot-help-icon {
                display: none;
            }
            .snapshot-btn .btn-icon {
                display: block;
            }
        }
    </style>
</head>
<body>
    <h1>ÊãñÊõ≥Ê™îÊ°à‰∏äÂÇ≥</h1>
    <input type="file" id="fileInput" multiple style="display: none;">
    <div id="dropzone">ÊãñÊõ≥Ê™îÊ°àÂà∞Ê≠§ËôïÊàñÈªûÊìäÈÅ∏Êìá (ÊîØÊè¥Â§öÊ™îÊ°à)</div>
    
    <div class="control-panel">
        <button class="control-btn" onclick="expandAll()">ÂÖ®ÈÉ®Â±ïÈñã</button>
        <button class="control-btn" onclick="collapseAll()">ÂÖ®ÈÉ®Êî∂Âêà</button>
    </div>
    
    <div id="results"></div>
    
    <button class="snapshot-btn" id="snapshotBtn" onclick="downloadSnapshot()" style="display: none;">
        <span class="btn-text">üíæ ÂÑ≤Â≠òÈ†ÅÈù¢Âø´ÁÖß</span>
        <span class="btn-icon">üíæ</span>
        <span class="snapshot-help-icon" title="‰∏ãËºâÁï∂ÂâçÈ†ÅÈù¢ÁöÑÂÆåÊï¥ÂâØÊú¨,ÂåÖÂê´ÊâÄÊúâÁµ±Ë®àÊï∏ÊìöÂíåÂàÜÊûêÁµêÊûú„ÄÇ&#10;&#10;‚Ä¢ ÂèØÈõ¢Á∑öÊü•Áúã,‰∏ç‰æùË≥¥‰ªª‰Ωï‰º∫ÊúçÂô®&#10;‚Ä¢ ‰øùÁïôÊâÄÊúâÂ±ïÈñã/Êî∂ÂêàÁãÄÊÖã&#10;‚Ä¢ ÁßªÈô§‰∏äÂÇ≥Âíå‰∏ãËºâÂäüËÉΩ,ÂÉÖ‰æõÈñ±ËÆÄ">?</span>
    </button>

    <script>
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');
        const results = document.getElementById('results');
        const snapshotBtn = document.getElementById('snapshotBtn');
        
        // Ê™¢Êü•ÊòØÂê¶Êúâ‰∏äÂÇ≥ÁöÑÊ™îÊ°àÔºåÊéßÂà∂Âø´ÁÖßÊåâÈàïÈ°ØÁ§∫
        function updateSnapshotButton() {
            const hasFiles = results.children.length > 0;
            snapshotBtn.style.display = hasFiles ? 'block' : 'none';
        }

        // ÈªûÊìäÈñãÂïüÊ™îÊ°àÈÅ∏ÊìáË¶ñÁ™ó
        dropzone.onclick = () => fileInput.click();

        // Ê™îÊ°àÈÅ∏ÊìáË¶ñÁ™óÈÅ∏ÊìáÂæå
        fileInput.onchange = (e) => {
            [...e.target.files].forEach(uploadFile);
            fileInput.value = ''; // Ê∏ÖÁ©∫‰ª•ÂÖÅË®±ÈáçË§áÈÅ∏ÊìáÁõ∏ÂêåÊ™îÊ°à
        };

        dropzone.ondragover = (e) => { e.preventDefault(); dropzone.classList.add('hover'); };
        dropzone.ondragleave = () => dropzone.classList.remove('hover');
        dropzone.ondrop = (e) => {
            e.preventDefault();
            dropzone.classList.remove('hover');
            [...e.dataTransfer.files].forEach(uploadFile);
        };

        function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            fetch('/upload', { method: 'POST', body: formData })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        const div = document.createElement('div');
                        div.className = 'file-info status-' + data.status;
                        div.id = 'file-' + data.file_id;
                        div.dataset.csvName = data.csv_download_name; // ÂÑ≤Â≠ò CSV Ê™îÂêç
                        
                        // Âª∫Á´ãÊ∏¨Ë©¶ÊëòË¶Å HTML
                        let summaryHtml = `
                            <div class="test-summary">
                                <strong>Ê∏¨Ë©¶ÊëòË¶Å:</strong>
                                ÈñãÂßãÊôÇÈñì: ${data.test_info.start_time || 'Unknown'} | 
                                Á∏ΩÊ∏¨Ë©¶: ${data.test_info.total_sessions} | 
                                <span style="color: green;">ÈÄöÈÅé: ${data.test_info.passed}</span> | 
                                <span style="color: red;">Â§±Êïó: ${data.test_info.failed}</span> | 
                                <span style="color: orange;">Áï∞Â∏∏: ${data.test_info.exception}</span>
                            </div>
                        `;
                        
                        // Âª∫Á´ãÊâÄÊúâ Command Âü∑Ë°åË®òÈåÑÁöÑÁµ±‰∏ÄÊäòÁñäÂçÄÂ°ä
                        let commandExecutionsHtml = '';
                        if (data.command_executions && Object.keys(data.command_executions).length > 0) {
                            const totalCommands = Object.keys(data.command_executions).length;
                            
                            // Ë®àÁÆóÊØèÂÄã Command ÁöÑÂπ≥ÂùáÂü∑Ë°åÊôÇÈñì‰∏¶ÊéíÂ∫è
                            const commandsWithAvg = Object.entries(data.command_executions).map(([cmd, executions]) => {
                                const validDurations = executions.filter(e => e.duration).map(e => e.duration);
                                const avgDuration = validDurations.length > 0 
                                    ? validDurations.reduce((a, b) => a + b, 0) / validDurations.length 
                                    : 0;
                                return { cmd, executions, avgDuration };
                            });
                            
                            // ÊåâÂπ≥ÂùáÂü∑Ë°åÊôÇÈñìÈôçÂ∫èÊéíÂ∫èÔºàÊúÄÈï∑ÁöÑÂú®‰∏äÈù¢Ôºâ
                            commandsWithAvg.sort((a, b) => b.avgDuration - a.avgDuration);
                            
                            commandExecutionsHtml = `
                                <details style="margin-top: 15px; background: #f0f7ff; padding: 12px; border-radius: 6px; border: 2px solid #1976D2;">
                                    <summary style="cursor: pointer; color: #1976D2; font-weight: bold; font-size: 1.05em;">
                                        üìä Command Âü∑Ë°åË®òÈåÑ (${totalCommands} È†ÖÊ∏¨Ë©¶)
                                        <button class="copy-btn" onclick="event.stopPropagation(); downloadCSV('${data.file_id}', this)" style="margin-left: 10px;">‰∏ãËºâ CSV</button>
                                        <span class="snapshot-help-icon" title="È°ØÁ§∫ÊâÄÊúâÊ∏¨Ë©¶ Command ÁöÑÂü∑Ë°åÁµ±Ë®àË≥áË®ä„ÄÇ&#10;&#10;‚Ä¢ ÊåâÂπ≥ÂùáÂü∑Ë°åÊôÇÈñìÈôçÂ∫èÊéíÂàó(ÊúÄÊÖ¢ÁöÑÂú®ÊúÄ‰∏äÈù¢)&#10;‚Ä¢ ÈªûÊìäÊØèÂÄã Command ÂèØÊü•ÁúãË©≥Á¥∞Âü∑Ë°åË®òÈåÑ&#10;‚Ä¢ ÂåÖÂê´ÊØèÊ¨°Âü∑Ë°åÁöÑ Group„ÄÅRound„ÄÅÊôÇÈñì„ÄÅÁµêÊûúÂíåÊ∫´Â∫¶&#10;‚Ä¢ ÂèØ‰∏ãËºâ CSV Ê™îÊ°àÈÄ≤Ë°åÈÄ≤‰∏ÄÊ≠•ÂàÜÊûê">?</span>
                                    </summary>
                                    <div style="margin-top: 12px; max-height: 600px; overflow-y: auto;">
                                        <div style="margin-bottom: 10px; padding: 8px; background: #fff; border-radius: 4px; border: 1px solid #ddd; position: sticky; top: 0; z-index: 10;">
                                            <strong style="color: #1976D2;">üìà Áµ±Ë®àÂúñË°®Ë™™Êòé</strong>
                                            <span class="help-icon" style="cursor: pointer;" title="ÂúñË°®Áµ±Ë®àÊñπÊ≥ïË™™ÊòéÔºö&#10;&#10;üü¶ ËóçËâ≤ÊäòÁ∑öÔºöÂØ¶ÈöõÂü∑Ë°åÊôÇÈñì&#10;üü© Á∂†Ëâ≤ËôõÁ∑öÔºöÂπ≥ÂùáÂÄº (Mean)&#10;üü® ÈªÉËâ≤ËôõÁ∑öÔºö¬±1œÉ Ê®ôÊ∫ñÂ∑ÆÁØÑÂúç (Á¥Ñ68%Êï∏ÊìöËêΩÂú®Ê≠§ÂçÄÈñì)&#10;üüß Ê©òËâ≤‰∏âËßíÔºöÁï∞Â∏∏ÂÄº (‰ΩøÁî®IQRÂõõÂàÜ‰ΩçË∑ùÊñπÊ≥ïÊ™¢Ê∏¨)&#10;üü• Á¥ÖËâ≤ÂúìÈªûÔºöÊ∏¨Ë©¶Â§±Êïó&#10;&#10;Ê®ôÊ∫ñÂ∑Æ (œÉ)ÔºöÊï∏ÂÄºË∂äÂ∞èË°®Á§∫Âü∑Ë°åÊôÇÈñìË∂äÁ©©ÂÆö&#10;IQR Áï∞Â∏∏ÂÄºÊ™¢Ê∏¨ÔºöQ1-1.5√óIQR Âà∞ Q3+1.5√óIQR ÁØÑÂúçÂ§ñË¶ñÁÇ∫Áï∞Â∏∏&#10;&#10;ÂèØË©ï‰º∞Ôºö&#10;‚Ä¢ Ë≠òÂà•ÊÄßËÉΩ‰∏çÁ©©ÂÆöÁöÑÊ∏¨Ë©¶&#10;‚Ä¢ ÁôºÁèæÂü∑Ë°åÊôÇÈñìÁï∞Â∏∏ÁöÑ Round&#10;‚Ä¢ Ë©ï‰º∞Ê∏¨Ë©¶ÂèØÈù†ÊÄß">?</span>
                                            <span style="margin-left: 15px;">
                                                <button class="control-btn" onclick="expandOutliers('${data.file_id}')" style="padding: 5px 12px; font-size: 0.85em; background: #FF9800; margin: 0 3px;">Â±ïÈñãÁï∞Â∏∏ÂÄº</button>
                                                <button class="control-btn" onclick="expandFails('${data.file_id}')" style="padding: 5px 12px; font-size: 0.85em; background: #f44336; margin: 0 3px;">Â±ïÈñãÂ§±ÊïóÈ†Ö</button>
                                                <button class="control-btn" onclick="collapseAllCharts('${data.file_id}')" style="padding: 5px 12px; font-size: 0.85em; background: #757575; margin: 0 3px;">ÂÖ®ÈÉ®Êî∂Âêà</button>
                                            </span>
                                        </div>
                                        ${commandsWithAvg.map(({ cmd, executions, avgDuration }) => {
                                            const failCount = executions.filter(e => e.result === 'Fail').length;
                                            const passCount = executions.filter(e => e.result === 'Pass').length;
                                            const exceptionCount = executions.filter(e => e.result === 'Exception').length;
                                            const validDurations = executions.filter(e => e.duration).map(e => e.duration);
                                            const avgDurationStr = avgDuration > 0 ? `Âπ≥Âùá ${avgDuration.toFixed(2)}s` : 'ÁÑ°ÊôÇÈñìË≥áÊñô';
                                            
                                            // Âè™È°ØÁ§∫ÈùûÈõ∂ÁöÑÁµêÊûúÁµ±Ë®à
                                            let resultStats = [];
                                            if (passCount > 0) resultStats.push(`<span style="color: green;">Pass: ${passCount}</span>`);
                                            if (failCount > 0) resultStats.push(`<span style="color: red;">Fail: ${failCount}</span>`);
                                            if (exceptionCount > 0) resultStats.push(`<span style="color: orange;">Exception: ${exceptionCount}</span>`);
                                            const resultStatsStr = resultStats.join(' | ');
                                            
                                            // Ë®àÁÆóÊ®ôÊ∫ñÂ∑Æ
                                            let stdDev = 0;
                                            if (validDurations.length > 1) {
                                                const variance = validDurations.reduce((sum, val) => sum + Math.pow(val - avgDuration, 2), 0) / validDurations.length;
                                                stdDev = Math.sqrt(variance);
                                            }
                                            
                                            // ‰ΩøÁî® IQR ÊñπÊ≥ïÊ™¢Ê∏¨Áï∞Â∏∏ÂÄº
                                            let outliers = [];
                                            if (validDurations.length >= 4) {
                                                const sorted = [...validDurations].sort((a, b) => a - b);
                                                const q1Index = Math.floor(sorted.length * 0.25);
                                                const q3Index = Math.floor(sorted.length * 0.75);
                                                const q1 = sorted[q1Index];
                                                const q3 = sorted[q3Index];
                                                const iqr = q3 - q1;
                                                const lowerBound = q1 - 1.5 * iqr;
                                                const upperBound = q3 + 1.5 * iqr;
                                                
                                                executions.forEach((exec, idx) => {
                                                    if (exec.duration && (exec.duration < lowerBound || exec.duration > upperBound)) {
                                                        outliers.push({ round: exec.round, value: exec.duration });
                                                    }
                                                });
                                            }
                                            
                                            // Áµ±Ë®àË≥áË®äÂ≠ó‰∏≤
                                            let statsInfo = '';
                                            if (validDurations.length > 0) {
                                                statsInfo = ` | œÉ=${stdDev.toFixed(3)}s`;
                                                if (outliers.length > 0) {
                                                    statsInfo += ` | <span style="color: #de9502; font-weight: bold;">‚ö† ${outliers.length} ÂÄãÁï∞Â∏∏ÂÄº</span>`;
                                                }
                                            }
                                            
                                            // ÁîüÊàêÂîØ‰∏ÄÁöÑ canvas ID
                                            const chartId = 'chart-' + data.file_id + '-' + Math.random().toString(36).substr(2, 9);
                                            
                                            // Âª∫Á´ãË°®Ê†º HTML
                                            const tableRows = executions.map(exec => {
                                                const resultColor = exec.result === 'Pass' ? 'green' : (exec.result === 'Fail' ? 'red' : 'orange');
                                                const durationStr = exec.duration ? exec.duration.toFixed(2) : 'N/A';
                                                const tempStr = exec.temperature || '-';
                                                return '<tr>' +
                                                    '<td style="padding: 6px; border: 1px solid #ccc;">' + exec.group + '</td>' +
                                                    '<td style="padding: 6px; border: 1px solid #ccc; text-align: center;">' + exec.round + '</td>' +
                                                    '<td style="padding: 6px; border: 1px solid #ccc;">' + exec.start_time + '</td>' +
                                                    '<td style="padding: 6px; border: 1px solid #ccc; text-align: right;">' + durationStr + '</td>' +
                                                    '<td style="padding: 6px; border: 1px solid #ccc; color: ' + resultColor + '; font-weight: bold;">' + exec.result + '</td>' +
                                                    '<td style="padding: 6px; border: 1px solid #ccc; text-align: right;">' + tempStr + '</td>' +
                                                    '</tr>';
                                            }).join('');
                                            
                                            return `
                                                <details class="cmd-chart-item" data-file-id="${data.file_id}" data-has-outliers="${outliers.length > 0}" data-has-fails="${failCount > 0}" style="margin-bottom: 10px; background: white; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                                                    <summary style="cursor: pointer; font-weight: bold;">
                                                        <code style="background: #e8e8e8; padding: 2px 6px; border-radius: 3px;">${cmd}</code>
                                                        <span style="margin-left: 10px; font-size: 0.9em;">
                                                            <span style="background: #fff3cd; padding: 2px 6px; border-radius: 3px; color: #856404;">${avgDurationStr}</span>${statsInfo} |
                                                            Âü∑Ë°å ${executions.length} Ê¨° - 
                                                            ${resultStatsStr}
                                                        </span>
                                                    </summary>
                                                    <div style="margin-top: 8px;">
                                                        <div style="background: #f9f9f9; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
                                                            <canvas id="${chartId}" style="max-height: 200px;"></canvas>
                                                        </div>
                                                        <div style="max-height: 300px; overflow-y: auto;">
                                                            <table style="width: 100%; font-size: 0.85em; border-collapse: collapse;">
                                                                <thead>
                                                                    <tr style="background: #e0e0e0;">
                                                                        <th style="padding: 6px; border: 1px solid #ccc;">Group</th>
                                                                        <th style="padding: 6px; border: 1px solid #ccc;">Round</th>
                                                                        <th style="padding: 6px; border: 1px solid #ccc;">Start Time</th>
                                                                        <th style="padding: 6px; border: 1px solid #ccc;">Duration (s)</th>
                                                                        <th style="padding: 6px; border: 1px solid #ccc;">Result</th>
                                                                        <th style="padding: 6px; border: 1px solid #ccc;">Temp (¬∞C)</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>${tableRows}</tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </details>
                                            `;
                                        }).join('')}
                                    </div>
                                </details>
                            `;
                        }
                        
                        // Âª∫Á´ãÂ§±ÊïóÈ†ÖÁõÆ HTML
                        let failedHtml = '';
                        if (data.failed_summaries && data.failed_summaries.length > 0) {
                            failedHtml = '<div style="margin-top: 10px;"><strong>Â§±ÊïóÈ†ÖÁõÆ:</strong></div>';
                            data.failed_summaries.forEach((fail, idx) => {
                                let tempBadge = '';
                                if (fail.temperature) {
                                    let tempClass = 'temp-hot'; // È†êË®≠ÁÇôÁÜ±
                                    if (fail.temperature < 25) {
                                        tempClass = 'temp-cold'; // ÂÜ∞ÂÜ∑
                                    } else if (fail.temperature <= 55) {
                                        tempClass = 'temp-normal'; // Â∏∏Ê∫´
                                    }
                                    tempBadge = `<span class="temp-badge ${tempClass}">${fail.temperature} ¬∞C</span>`;
                                }
                                
                                failedHtml += `
                                    <div class="fail-item">
                                        <strong>#${idx + 1} ${fail.command}</strong> ${tempBadge}<br>
                                        <small>Group: ${fail.group} | Round: ${fail.round} | Time: ${fail.start_time}</small>
                                        <details style="margin-top: 5px;">
                                            <summary style="cursor: pointer; color: #1976D2;">
                                                Êü•ÁúãÂÆåÊï¥ Log
                                                <button class="copy-btn" onclick="event.stopPropagation(); copyLog(this, 'log-${data.file_id}-${idx}')">Ë§áË£Ω</button>
                                            </summary>
                                            <pre id="log-${data.file_id}-${idx}" style="font-size: 0.85em; max-height: 300px; overflow-y: auto;">${fail.log_full}</pre>
                                        </details>
                                    </div>
                                `;
                            });
                        }
                        
                        // ÁµÑÂêàÂÆåÊï¥ HTML
                        div.innerHTML = `
                            <span class="upload-time">Upload time:<br>${data.upload_time}</span>
                            <div class="file-header" onclick="toggleContent('${data.file_id}')">
                                <h3>
                                    <span class="toggle-icon collapsed" id="icon-${data.file_id}">‚ñº</span>${data.filename}
                                    ${data.test_info.failed > 0 ? `<span class="fail-count">(${data.test_info.failed} fail)</span>` : ''}
                                </h3>
                            </div>
                            <div class="file-content collapsed" id="content-${data.file_id}">
                                ${summaryHtml}
                                ${commandExecutionsHtml}
                                ${failedHtml}
                                <div class="button-group" style="margin-top: 15px; position: relative;">
                                    <div style="display: inline-flex; gap: 5px; margin-right: 10px;">
                                        <button class="download-btn" onclick="viewRaw('${data.file_id}')" title="Âú®Êñ∞ÂàÜÈ†ÅÊü•ÁúãÂéüÂßã log ÂÖßÂÆπ">
                                            Raw
                                        </button>
                                        <button class="download-btn" onclick="download('${data.file_id}')" title="‰∏ãËºâÂéüÂßã log Ê™îÊ°à">
                                            ‰∏ãËºâ Raw
                                        </button>
                                    </div>
                                    ${data.has_fail_report ? 
                                        `<button class="download-btn" style="background: #ff5722;" onclick="downloadFailReport('${data.file_id}')" title="Áµ±Êï¥ log ‰∏≠ÁöÑÊâÄÊúâ fail ÂçÄÂ°ä">
                                            ‰∏ãËºâ Fail Report
                                        </button>` : ''}
                                    <button class="clear-btn" onclick="clearFile('${data.file_id}')" style="position: absolute; bottom: 0; right: 0;" title="ÁßªÈô§Ê≠§Áµ±Ë®àÈ†ÖÁõÆÊäòÁñä">
                                        Ê∏ÖÈô§
                                    </button>
                                </div>
                            </div>
                        `;
                        results.insertBefore(div, results.firstChild);
                        
                        // ÁÇ∫ÊØèÂÄã command ÂâµÂª∫ÂúñË°®
                        if (data.command_executions && Object.keys(data.command_executions).length > 0) {
                            // Âª∂ÈÅ≤Âü∑Ë°å‰ª•Á¢∫‰øù DOM Â∑≤Á∂ìÊ∏≤Êüì
                            setTimeout(() => {
                                const commandsWithAvg = Object.entries(data.command_executions).map(([cmd, executions]) => {
                                    const validDurations = executions.filter(e => e.duration).map(e => e.duration);
                                    const avgDuration = validDurations.length > 0 
                                        ? validDurations.reduce((a, b) => a + b, 0) / validDurations.length 
                                        : 0;
                                    return { cmd, executions, avgDuration };
                                });
                                
                                commandsWithAvg.sort((a, b) => b.avgDuration - a.avgDuration);
                                
                                const canvases = div.querySelectorAll('canvas');
                                canvases.forEach((canvas, idx) => {
                                    if (canvas && !canvas.chart && idx < commandsWithAvg.length) {
                                        const { executions } = commandsWithAvg[idx];
                                        const ctx = canvas.getContext('2d');
                                        
                                        const labels = executions.map(e => 'R' + e.round);
                                        const durations = executions.map(e => e.duration || 0);
                                        const failPoints = executions.map(e => e.result === 'Fail' ? (e.duration || 0) : null);
                                        
                                        // Ë®àÁÆóÂπ≥ÂùáÂÄºÂíåÊ®ôÊ∫ñÂ∑ÆÁî®ÊñºÂúñË°®È°ØÁ§∫
                                        const validDurations = durations.filter(d => d > 0);
                                        const mean = validDurations.reduce((a, b) => a + b, 0) / validDurations.length;
                                        let stdDev = 0;
                                        if (validDurations.length > 1) {
                                            const variance = validDurations.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / validDurations.length;
                                            stdDev = Math.sqrt(variance);
                                        }
                                        
                                        // Ê™¢Ê∏¨Áï∞Â∏∏ÂÄº
                                        const outlierPoints = [];
                                        if (validDurations.length >= 4) {
                                            const sorted = [...validDurations].sort((a, b) => a - b);
                                            const q1 = sorted[Math.floor(sorted.length * 0.25)];
                                            const q3 = sorted[Math.floor(sorted.length * 0.75)];
                                            const iqr = q3 - q1;
                                            const lowerBound = q1 - 1.5 * iqr;
                                            const upperBound = q3 + 1.5 * iqr;
                                            
                                            durations.forEach((d, i) => {
                                                if (d > 0 && (d < lowerBound || d > upperBound)) {
                                                    outlierPoints.push(d);
                                                } else {
                                                    outlierPoints.push(null);
                                                }
                                            });
                                        }
                                        
                                        canvas.chart = new Chart(ctx, {
                                            type: 'line',
                                            data: {
                                                labels: labels,
                                                datasets: [{
                                                    label: 'Âü∑Ë°åÊôÇÈñì',
                                                    data: durations,
                                                    borderColor: '#2196F3',
                                                    backgroundColor: 'rgba(33, 150, 243, 0.1)',
                                                    tension: 0.3,
                                                    pointRadius: 4
                                                }, {
                                                    label: 'Âπ≥ÂùáÂÄº',
                                                    data: Array(durations.length).fill(mean),
                                                    borderColor: '#4CAF50',
                                                    borderWidth: 2,
                                                    borderDash: [5, 5],
                                                    pointRadius: 0,
                                                    fill: false
                                                }, {
                                                    label: '¬±1œÉ ‰∏äÁïå',
                                                    data: Array(durations.length).fill(mean + stdDev),
                                                    borderColor: '#FFC107',
                                                    borderWidth: 1,
                                                    borderDash: [2, 2],
                                                    pointRadius: 0,
                                                    fill: false
                                                }, {
                                                    label: '¬±1œÉ ‰∏ãÁïå',
                                                    data: Array(durations.length).fill(mean - stdDev),
                                                    borderColor: '#FFC107',
                                                    borderWidth: 1,
                                                    borderDash: [2, 2],
                                                    pointRadius: 0,
                                                    fill: false
                                                }, {
                                                    label: 'Áï∞Â∏∏ÂÄº (IQR)',
                                                    data: outlierPoints,
                                                    backgroundColor: '#FF9800',
                                                    pointRadius: 10,
                                                    pointStyle: 'triangle',
                                                    showLine: false
                                                }, {
                                                    label: 'Fail',
                                                    data: failPoints,
                                                    backgroundColor: '#f44336',
                                                    pointRadius: 8,
                                                    showLine: false
                                                }]
                                            },
                                            options: {
                                                responsive: true,
                                                maintainAspectRatio: true,
                                                aspectRatio: 2.5,
                                                plugins: {
                                                    legend: { display: true, position: 'top', labels: { boxWidth: 15, padding: 10, font: { size: 11 } } }
                                                },
                                                scales: {
                                                    y: { beginAtZero: true, ticks: { font: { size: 10 } }, title: { display: true, text: 'Áßí', font: { size: 11 } } },
                                                    x: { ticks: { font: { size: 10 } }, title: { display: true, text: 'Round', font: { size: 11 } } }
                                                }
                                            }
                                        });
                                    }
                                });
                            }, 100);
                        }
                        
                        updateSnapshotButton(); // Êõ¥Êñ∞Âø´ÁÖßÊåâÈàïÈ°ØÁ§∫ÁãÄÊÖã
                    } else {
                        alert('‰∏äÂÇ≥Â§±Êïó: ' + data.error);
                    }
                });
        }

        function toggleContent(fileId) {
            const content = document.getElementById('content-' + fileId);
            const icon = document.getElementById('icon-' + fileId);
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                content.classList.add('collapsed');
                icon.classList.add('collapsed');
            } else {
                content.classList.remove('collapsed');
                content.classList.add('expanded');
                icon.classList.remove('collapsed');
            }
        }

        function expandAll() {
            document.querySelectorAll('.file-content').forEach(content => {
                content.classList.remove('collapsed');
                content.classList.add('expanded');
            });
            document.querySelectorAll('.toggle-icon').forEach(icon => {
                icon.classList.remove('collapsed');
            });
        }

        function collapseAll() {
            document.querySelectorAll('.file-content').forEach(content => {
                content.classList.remove('expanded');
                content.classList.add('collapsed');
            });
            document.querySelectorAll('.toggle-icon').forEach(icon => {
                icon.classList.add('collapsed');
            });
        }
        
        // Â±ïÈñãÊâÄÊúâÊúâÁï∞Â∏∏ÂÄºÁöÑÂúñË°®
        function expandOutliers(fileId) {
            const items = document.querySelectorAll(`.cmd-chart-item[data-file-id="${fileId}"][data-has-outliers="true"]`);
            items.forEach(item => {
                item.open = true;
            });
        }
        
        // Â±ïÈñãÊâÄÊúâÊúâÂ§±ÊïóÁöÑÂúñË°®
        function expandFails(fileId) {
            const items = document.querySelectorAll(`.cmd-chart-item[data-file-id="${fileId}"][data-has-fails="true"]`);
            items.forEach(item => {
                item.open = true;
            });
        }
        
        // Êî∂ÂêàË©≤Ê™îÊ°àÁöÑÊâÄÊúâÂúñË°®
        function collapseAllCharts(fileId) {
            const items = document.querySelectorAll(`.cmd-chart-item[data-file-id="${fileId}"]`);
            items.forEach(item => {
                item.open = false;
            });
        }

        function viewRaw(fileId) {
            window.open('/raw/' + fileId, '_blank');
        }

        function download(fileId) {
            window.location.href = '/download/' + fileId;
        }

        function downloadFailReport(fileId) {
            window.location.href = '/download_fail_report/' + fileId;
        }
        
        function downloadCSV(fileId, button) {
            // Âæû DOM ‰∏≠ÂèñÂæóË©≤ fileId ÁöÑ command_executions Ë≥áÊñô
            const fileElement = document.getElementById('file-' + fileId);
            if (!fileElement) {
                alert('Êâæ‰∏çÂà∞Ê™îÊ°àË≥áÊñô');
                return;
            }
            
            // Áç≤ÂèñÊ≠£Á¢∫ÁöÑ CSV Ê™îÂêç
            const csvFileName = fileElement.dataset.csvName || 'time_stat.csv';
            
            // ÂæûÂÖ®Â±ÄËÆäÊï∏ÊàñÈáçÊñ∞Âæû data ÂèñÂæóÔºàÈúÄË¶ÅÂæåÁ´ØÊîØÊè¥Ôºâ
            fetch('/download_csv/' + fileId)
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = csvFileName;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                })
                .catch(err => {
                    alert('‰∏ãËºâ CSV Â§±Êïó: ' + err);
                });
        }

        function clearFile(fileId) {
            const element = document.getElementById('file-' + fileId);
            if (element) {
                element.remove();
                updateSnapshotButton(); // Êõ¥Êñ∞Âø´ÁÖßÊåâÈàïÈ°ØÁ§∫ÁãÄÊÖã
            }
        }

        function copyLog(button, logId) {
            const logElement = document.getElementById(logId);
            const text = logElement.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = '‚úì Â∑≤Ë§áË£Ω';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                alert('Ë§áË£ΩÂ§±Êïó: ' + err);
            });
        }
        
        function downloadSnapshot() {
            // ‰ΩøÁî® async IIFE (Á´ãÂç≥Âü∑Ë°åÁöÑ async ÂáΩÊï∏)
            (async () => {
                // Ë§áË£ΩÁï∂ÂâçÈ†ÅÈù¢ÁöÑ HTMLÔºà‰ΩøÁî® true ÈÄ≤Ë°åÊ∑±Â∫¶Ë§áË£ΩÔºâ
                const htmlContent = document.documentElement.cloneNode(true);
                
                // ËôïÁêÜ Chart.js script - Âæû server ËÆÄÂèñ‰∏¶ÂµåÂÖ•
                const chartScript = htmlContent.querySelector('head script[src*="chart"]');
                let chartJsLoaded = false;
                
                if (chartScript) {
                    try {
                        // Âæû server ËÆÄÂèñ Chart.js ÂÖßÂÆπ
                        const response = await fetch(chartScript.src);
                        const chartJsContent = await response.text();
                        
                        // Âú® htmlContent ÁöÑ‰∏ä‰∏ãÊñá‰∏≠ÂâµÂª∫ script
                        // ÊñπÊ≥ï1: Áõ¥Êé•‰øÆÊîπ textContent (ÊúÄÁ∞°ÂñÆ)
                        chartScript.removeAttribute('src'); // ÁßªÈô§ src Â±¨ÊÄß
                        chartScript.textContent = chartJsContent; // Ë®≠ÂÆöÁÇ∫ inline script
                        chartScript.dataset.keepScript = 'true'; // Ê®ôË®òÁÇ∫ÈúÄË¶Å‰øùÁïôÁöÑ script
                        
                        chartJsLoaded = true;
                    } catch (err) {
                        console.warn('ÁÑ°Ê≥ïËºâÂÖ• Chart.jsÔºåÂø´ÁÖßÂ∞áÂè™ÂåÖÂê´ÈùúÊÖãÂúñË°®ÂúñÁâá', err);
                        chartScript.remove();
                    }
                }
                
                // Âè™ÊúâÂú® Chart.js ËºâÂÖ•Â§±ÊïóÊôÇÔºåÊâçÂ∞á canvas ËΩâÊèõÁÇ∫ÂúñÁâá
                if (!chartJsLoaded) {
                    const canvases = document.querySelectorAll('canvas');
                    const clonedCanvases = htmlContent.querySelectorAll('canvas');
                    canvases.forEach((canvas, idx) => {
                        if (canvas.chart && clonedCanvases[idx]) {
                            const img = document.createElement('img');
                            img.src = canvas.toDataURL('image/png');
                            img.style.width = '100%';
                            img.style.maxHeight = '200px';
                            clonedCanvases[idx].parentNode.replaceChild(img, clonedCanvases[idx]);
                        }
                    });
                } else {
                    // Chart.js ËºâÂÖ•ÊàêÂäüÊôÇÔºåÊî∂ÈõÜÊâÄÊúâÂúñË°®ÈÖçÁΩÆ‰∏¶Ê≥®ÂÖ•Âà∞Âø´ÁÖß‰∏≠
                    const canvases = document.querySelectorAll('canvas');
                    const chartConfigs = {};
                    
                    canvases.forEach((canvas) => {
                        if (canvas.chart && canvas.id) {
                            // ÂÑ≤Â≠òÂúñË°®ÈÖçÁΩÆ
                            chartConfigs[canvas.id] = {
                                labels: canvas.chart.data.labels,
                                datasets: canvas.chart.data.datasets,
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: true,
                                    aspectRatio: 2.5,
                                    plugins: {
                                        legend: { display: true, position: 'top', labels: { boxWidth: 15, padding: 10, font: { size: 11 } } }
                                    },
                                    scales: {
                                        y: { beginAtZero: true, ticks: { font: { size: 10 } }, title: { display: true, text: 'Áßí', font: { size: 11 } } },
                                        x: { ticks: { font: { size: 10 } }, title: { display: true, text: 'Round', font: { size: 11 } } }
                                    }
                                }
                            };
                        }
                    });
                    
                    // Âú® head ‰∏≠Ê≥®ÂÖ•ÂúñË°®ÈÖçÁΩÆ
                    const configScript = document.createElement('script');
                    configScript.textContent = `window.chartConfigs = ${JSON.stringify(chartConfigs)};`;
                    configScript.dataset.keepScript = 'true';
                    const head = htmlContent.querySelector('head');
                    if (head) {
                        head.appendChild(configScript);
                    }
                    
                    // ÁßªÈô§ÊâÄÊúâ base64 ÂúñÁâá
                    const base64Images = htmlContent.querySelectorAll('img[src^="data:image"]');
                    base64Images.forEach(img => {
                        console.log('ÁßªÈô§ base64 ÂúñÁâá:', img.src.substring(0, 50));
                        img.remove();
                    });
                }
                
                // ÁßªÈô§‰∏äÂÇ≥ÂçÄÂüüÂíåÊéßÂà∂Èù¢ÊùøÔºàÈÄô‰∫õÊòØÊ®°Êùø‰∏≠ÁöÑÈùúÊÖãÂÖÉÁ¥†Ôºâ
            const dropzone = htmlContent.querySelector('#dropzone');
            const fileInput = htmlContent.querySelector('#fileInput');
            const controlPanel = htmlContent.querySelector('.control-panel');
            const snapshotBtn = htmlContent.querySelector('.snapshot-btn');
            const h1 = htmlContent.querySelector('h1');
            
            if (dropzone) dropzone.remove();
            if (fileInput) fileInput.remove();
            if (controlPanel) controlPanel.remove();
            if (snapshotBtn) snapshotBtn.remove();
            if (h1) h1.textContent = 'ALE Log Analysis Report (Snapshot)';
            
            // ÁßªÈô§ÊâÄÊúâÊåâÈàïÔºà‰ΩÜ‰øùÁïôÊäòÁñäÂäüËÉΩÔºâ
            htmlContent.querySelectorAll('.download-btn, .clear-btn, .copy-btn').forEach(btn => btn.remove());
            
            // ÁßªÈô§‰∏äÂÇ≥Áõ∏ÈóúÁöÑ‰∫ã‰ª∂ËôïÁêÜÂô®Ôºå‰ΩÜ‰øùÁïô toggleContent
            const scripts = htmlContent.querySelectorAll('script');
            scripts.forEach(script => {
                // ‰øùÁïôÊ®ôË®òÁÇ∫ keepScript ÁöÑ script (‰æãÂ¶Ç Chart.js)
                if (script.dataset.keepScript === 'true') {
                    return; // Ë∑≥ÈÅé,‰∏çËôïÁêÜ
                }
                
                const scriptText = script.textContent;
                // Âè™‰øùÁïôÂøÖË¶ÅÁöÑ toggleContent ÂáΩÊï∏ÂíåÁõ∏ÈóúÂäüËÉΩ
                if (scriptText.includes('uploadFile') || scriptText.includes('downloadCSV') || 
                    scriptText.includes('download(') || scriptText.includes('downloadFailReport') ||
                    scriptText.includes('clearFile') || scriptText.includes('copyLog') ||
                    scriptText.includes('updateSnapshotButton') || scriptText.includes('downloadSnapshot')) {
                    // ÁßªÈô§‰∏çÈúÄË¶ÅÁöÑÂáΩÊï∏Ôºå‰ΩÜ‰øùÁïô toggleContent, expandAll, collapseAll
                    // ‰∏¶Ê∑ªÂä†ÂúñË°®ÂàùÂßãÂåñÈÇèËºØ
                    const essentialScript = `
                        function toggleContent(fileId) {
                            const content = document.getElementById('content-' + fileId);
                            const icon = document.getElementById('icon-' + fileId);
                            
                            if (content.classList.contains('expanded')) {
                                content.classList.remove('expanded');
                                content.classList.add('collapsed');
                                icon.classList.add('collapsed');
                            } else {
                                content.classList.remove('collapsed');
                                content.classList.add('expanded');
                                icon.classList.remove('collapsed');
                            }
                        }

                        function expandAll() {
                            document.querySelectorAll('.file-content').forEach(content => {
                                content.classList.remove('collapsed');
                                content.classList.add('expanded');
                            });
                            document.querySelectorAll('.toggle-icon').forEach(icon => {
                                icon.classList.remove('collapsed');
                            });
                        }

                        function collapseAll() {
                            document.querySelectorAll('.file-content').forEach(content => {
                                content.classList.remove('expanded');
                                content.classList.add('collapsed');
                            });
                            document.querySelectorAll('.toggle-icon').forEach(icon => {
                                icon.classList.add('collapsed');
                            });
                        }
                        
                        // Â±ïÈñãÊâÄÊúâÊúâÁï∞Â∏∏ÂÄºÁöÑÂúñË°®
                        function expandOutliers(fileId) {
                            const items = document.querySelectorAll('.cmd-chart-item[data-file-id="' + fileId + '"][data-has-outliers="true"]');
                            items.forEach(item => {
                                item.open = true;
                            });
                        }
                        
                        // Â±ïÈñãÊâÄÊúâÊúâÂ§±ÊïóÁöÑÂúñË°®
                        function expandFails(fileId) {
                            const items = document.querySelectorAll('.cmd-chart-item[data-file-id="' + fileId + '"][data-has-fails="true"]');
                            items.forEach(item => {
                                item.open = true;
                            });
                        }
                        
                        // Êî∂ÂêàË©≤Ê™îÊ°àÁöÑÊâÄÊúâÂúñË°®
                        function collapseAllCharts(fileId) {
                            const items = document.querySelectorAll('.cmd-chart-item[data-file-id="' + fileId + '"]');
                            items.forEach(item => {
                                item.open = false;
                            });
                        }
                        
                        // ÂàùÂßãÂåñÊâÄÊúâÂúñË°®
                        window.addEventListener('DOMContentLoaded', function() {
                            // Ê™¢Êü•ÊòØÂê¶ÊúâÈ†êÂÖàÂÑ≤Â≠òÁöÑÂúñË°®ÈÖçÁΩÆ
                            if (!window.chartConfigs) {
                                console.warn('Ê≤íÊúâÊâæÂà∞ÂúñË°®ÈÖçÁΩÆÔºåÂø´ÁÖßÂèØËÉΩÁÑ°Ê≥ïÈ°ØÁ§∫ÂúñË°®');
                                return;
                            }
                            
                            const canvases = document.querySelectorAll('canvas');
                            canvases.forEach(canvas => {
                                if (canvas.chart) return; // Â∑≤Á∂ìÂàùÂßãÂåñÈÅé
                                
                                const canvasId = canvas.id;
                                const config = window.chartConfigs[canvasId];
                                
                                if (!config) {
                                    console.warn('Êâæ‰∏çÂà∞ canvas', canvasId, 'ÁöÑÂúñË°®ÈÖçÁΩÆ');
                                    return;
                                }
                                
                                try {
                                    const ctx = canvas.getContext('2d');
                                    canvas.chart = new Chart(ctx, {
                                        type: 'line',
                                        data: {
                                            labels: config.labels,
                                            datasets: config.datasets
                                        },
                                        options: config.options
                                    });
                                    console.log('ÊàêÂäüÂàùÂßãÂåñÂúñË°®:', canvasId);
                                } catch (err) {
                                    console.error('ÂúñË°®ÂàùÂßãÂåñÂ§±Êïó:', canvasId, err);
                                }
                            });
                        });
                    `;
                    script.textContent = essentialScript;
                } else {
                    script.remove();
                }
            });
            
            // Êõ¥Êñ∞Ê®ôÈ°å
            const title = htmlContent.querySelector('title');
            if (title) {
                title.textContent = 'ALE Log Analysis Report - ' + new Date().toLocaleString('zh-TW');
            }
            
            // Âú®È†ÇÈÉ®Ê∑ªÂä†Âø´ÁÖßË≥áË®äÂíåÊéßÂà∂ÊåâÈàï
            const body = htmlContent.querySelector('body');
            if (body) {
                const infoDiv = document.createElement('div');
                infoDiv.style.cssText = 'background: #fff3cd; padding: 15px; margin: 20px 0; border-left: 4px solid #ffc107; border-radius: 4px;';
                infoDiv.innerHTML = `
                    <strong>üì∏ È†ÅÈù¢Âø´ÁÖß</strong><br>
                    <small>ÁîüÊàêÊôÇÈñì: ${new Date().toLocaleString('zh-TW')}</small><br>
                    <small>Ê≠§ÁÇ∫ÈùúÊÖãÂø´ÁÖßÔºåÂÉÖ‰æõÈñ±ËÆÄ„ÄÇÊ™îÊ°àÊï∏Èáè: ${document.getElementById('results').children.length}</small>
                    <div style="margin-top: 10px;">
                        <button class="control-btn" onclick="expandAll()">ÂÖ®ÈÉ®Â±ïÈñã</button>
                        <button class="control-btn" onclick="collapseAll()">ÂÖ®ÈÉ®Êî∂Âêà</button>
                    </div>
                `;
                body.insertBefore(infoDiv, body.firstChild);
            }
            
            // ÁîüÊàêÂÆåÊï¥ÁöÑ HTML Â≠ó‰∏≤
            const htmlString = '<!DOCTYPE html>\n' + htmlContent.outerHTML;
            
            // Âª∫Á´ã‰∏ãËºâÈÄ£Áµê
            const blob = new Blob([htmlString], { type: 'text/html;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            // Ê†ºÂºèÂåñÊôÇÈñìÁÇ∫ YYYY-MM-DD_HH-MM-SS
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const timestamp = `${year}-${month}-${day}_${hours}-${minutes}-${seconds}`;
            
            a.download = `ale_log_report_${timestamp}.html`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            })(); // ÁµêÊùü async IIFE
        }
    </script>
</body>
</html>

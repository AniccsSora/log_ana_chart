<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ALE Log Analyzer</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ…°ï¸</text></svg>">
    <style>
        body { font-family: Arial; max-width: 800px; margin: 50px auto; padding: 20px; }
        #dropzone { border: 3px dashed #ccc; padding: 50px; text-align: center; margin: 20px 0; cursor: pointer; transition: all 0.3s; }
        #dropzone:hover { border-color: #666; background: #fafafa; }
        #dropzone.hover { border-color: #333; background: #f0f0f0; }
        .file-info { background: #f9f9f9; padding: 15px; margin: 10px 0; border-left: 4px solid #4CAF50; position: relative; }
        .file-info.status-pass { border-left-color: #4CAF50; }
        .file-info.status-fail { border-left-color: #f44336; }
        .file-info.status-unknown { border-left-color: #FF9800; }
        .upload-time { 
            position: absolute; 
            top: 10px; 
            right: 15px; 
            font-size: 0.75em; 
            color: #666; 
            text-align: right;
            line-height: 1.4;
        }
        .download-btn { background: #4CAF50; color: white; padding: 10px 20px; border: none; cursor: pointer; margin: 5px; border-radius: 4px; }
        .download-btn:hover { background: #45a049; }
        .clear-btn { background: #f44336; color: white; padding: 8px 16px; border: none; cursor: pointer; margin: 5px; border-radius: 4px; }
        .clear-btn:hover { background: #da190b; }
        pre { background: #f4f4f4; padding: 10px; overflow-x: auto; }
        .button-group { margin-top: 10px; }
        .control-panel { margin: 20px 0; text-align: center; }
        .control-btn { background: #2196F3; color: white; padding: 10px 20px; border: none; cursor: pointer; margin: 0 5px; border-radius: 4px; }
        .control-btn:hover { background: #0b7dda; }
        .file-content { overflow: hidden; transition: max-height 0.3s ease; }
        .file-content.collapsed { max-height: 0; }
        .file-content.expanded { max-height: 5000px; }
        .file-header { cursor: pointer; user-select: none; }
        .file-header:hover { background: #f0f0f0; }
        .toggle-icon { display: inline-block; margin-right: 5px; transition: transform 0.3s; }
        .toggle-icon.collapsed { transform: rotate(-90deg); }
        .fail-count { color: #f44336; font-weight: bold; margin-left: 10px; font-size: 0.9em; }
        .test-summary { background: #e3f2fd; padding: 10px; margin: 10px 0; border-radius: 4px; font-size: 0.9em; }
        .test-summary strong { color: #1976D2; }
        .fail-item { background: #ffebee; padding: 10px; margin: 5px 0; border-left: 3px solid #f44336; }
        .fail-item strong { color: #c62828; }
        .temp-badge { color: white; padding: 2px 8px; border-radius: 3px; font-size: 0.85em; }
        .temp-cold { background: #2196F3; }
        .temp-normal { background: #4CAF50; }
        .temp-hot { background: #ff5722; }
        .copy-btn { background: #607D8B; color: white; padding: 4px 12px; border: none; cursor: pointer; border-radius: 3px; font-size: 0.85em; margin-left: 10px; }
        .copy-btn:hover { background: #455A64; }
        .copy-btn.copied { background: #4CAF50; }
        .help-icon { 
            display: inline-block;
            width: 18px;
            height: 18px;
            background: #2196F3;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 18px;
            font-size: 0.8em;
            margin-left: 8px;
            cursor: help;
            font-weight: bold;
        }
        .help-icon:hover { 
            background: #1976D2;
            cursor: none;
        }
        .snapshot-help-icon {
            display: inline-block;
            width: 22px;
            height: 22px;
            background: #2196F3;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 22px;
            font-size: 0.9em;
            margin-left: 8px;
            cursor: help;
            font-weight: bold;
            position: relative;
        }
        .snapshot-help-icon:hover { 
            background: #1976D2;
        }
        .snapshot-help-icon .tooltip-text {
            visibility: hidden;
            width: 300px;
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -150px;
            opacity: 0;
            transition: opacity 0.1s;
            font-size: 13px;
            line-height: 1.5;
            white-space: pre-line;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .snapshot-help-icon .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        .snapshot-help-icon:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        .snapshot-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #9C27B0;
            color: white;
            padding: 15px 25px;
            border: none;
            cursor: pointer;
            border-radius: 50px;
            font-size: 1em;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            z-index: 1000;
            transition: all 0.3s;
        }
        .snapshot-btn:hover {
            background: #7B1FA2;
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <h1>æ‹–æ›³æª”æ¡ˆä¸Šå‚³</h1>
    <input type="file" id="fileInput" multiple style="display: none;">
    <div id="dropzone">æ‹–æ›³æª”æ¡ˆåˆ°æ­¤è™•æˆ–é»æ“Šé¸æ“‡ (æ”¯æ´å¤šæª”æ¡ˆ)</div>
    
    <div class="control-panel">
        <button class="control-btn" onclick="expandAll()">å…¨éƒ¨å±•é–‹</button>
        <button class="control-btn" onclick="collapseAll()">å…¨éƒ¨æ”¶åˆ</button>
    </div>
    
    <div id="results"></div>
    
    <button class="snapshot-btn" id="snapshotBtn" onclick="downloadSnapshot()" style="display: none;">
        ğŸ’¾ å„²å­˜é é¢å¿«ç…§
        <span class="snapshot-help-icon">?
            <span class="tooltip-text">ä¸‹è¼‰ç•¶å‰é é¢çš„å®Œæ•´å‰¯æœ¬,åŒ…å«æ‰€æœ‰çµ±è¨ˆæ•¸æ“šå’Œåˆ†æçµæœã€‚

â€¢ å¯é›¢ç·šæŸ¥çœ‹,ä¸ä¾è³´ä»»ä½•ä¼ºæœå™¨
â€¢ ä¿ç•™æ‰€æœ‰å±•é–‹/æ”¶åˆç‹€æ…‹
â€¢ ç§»é™¤ä¸Šå‚³å’Œä¸‹è¼‰åŠŸèƒ½,åƒ…ä¾›é–±è®€</span>
        </span>
    </button>

    <script>
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');
        const results = document.getElementById('results');
        const snapshotBtn = document.getElementById('snapshotBtn');
        
        // æª¢æŸ¥æ˜¯å¦æœ‰ä¸Šå‚³çš„æª”æ¡ˆï¼Œæ§åˆ¶å¿«ç…§æŒ‰éˆ•é¡¯ç¤º
        function updateSnapshotButton() {
            const hasFiles = results.children.length > 0;
            snapshotBtn.style.display = hasFiles ? 'block' : 'none';
        }

        // é»æ“Šé–‹å•Ÿæª”æ¡ˆé¸æ“‡è¦–çª—
        dropzone.onclick = () => fileInput.click();

        // æª”æ¡ˆé¸æ“‡è¦–çª—é¸æ“‡å¾Œ
        fileInput.onchange = (e) => {
            [...e.target.files].forEach(uploadFile);
            fileInput.value = ''; // æ¸…ç©ºä»¥å…è¨±é‡è¤‡é¸æ“‡ç›¸åŒæª”æ¡ˆ
        };

        dropzone.ondragover = (e) => { e.preventDefault(); dropzone.classList.add('hover'); };
        dropzone.ondragleave = () => dropzone.classList.remove('hover');
        dropzone.ondrop = (e) => {
            e.preventDefault();
            dropzone.classList.remove('hover');
            [...e.dataTransfer.files].forEach(uploadFile);
        };

        function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            fetch('/upload', { method: 'POST', body: formData })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        const div = document.createElement('div');
                        div.className = 'file-info status-' + data.status;
                        div.id = 'file-' + data.file_id;
                        div.dataset.csvName = data.csv_download_name; // å„²å­˜ CSV æª”å
                        
                        // å»ºç«‹æ¸¬è©¦æ‘˜è¦ HTML
                        let summaryHtml = `
                            <div class="test-summary">
                                <strong>æ¸¬è©¦æ‘˜è¦:</strong>
                                é–‹å§‹æ™‚é–“: ${data.test_info.start_time || 'Unknown'} | 
                                ç¸½æ¸¬è©¦: ${data.test_info.total_sessions} | 
                                <span style="color: green;">é€šé: ${data.test_info.passed}</span> | 
                                <span style="color: red;">å¤±æ•—: ${data.test_info.failed}</span> | 
                                <span style="color: orange;">ç•°å¸¸: ${data.test_info.exception}</span>
                            </div>
                        `;
                        
                        // å»ºç«‹æ‰€æœ‰ Command åŸ·è¡Œè¨˜éŒ„çš„çµ±ä¸€æŠ˜ç–Šå€å¡Š
                        let commandExecutionsHtml = '';
                        if (data.command_executions && Object.keys(data.command_executions).length > 0) {
                            const totalCommands = Object.keys(data.command_executions).length;
                            
                            // è¨ˆç®—æ¯å€‹ Command çš„å¹³å‡åŸ·è¡Œæ™‚é–“ä¸¦æ’åº
                            const commandsWithAvg = Object.entries(data.command_executions).map(([cmd, executions]) => {
                                const validDurations = executions.filter(e => e.duration).map(e => e.duration);
                                const avgDuration = validDurations.length > 0 
                                    ? validDurations.reduce((a, b) => a + b, 0) / validDurations.length 
                                    : 0;
                                return { cmd, executions, avgDuration };
                            });
                            
                            // æŒ‰å¹³å‡åŸ·è¡Œæ™‚é–“é™åºæ’åºï¼ˆæœ€é•·çš„åœ¨ä¸Šé¢ï¼‰
                            commandsWithAvg.sort((a, b) => b.avgDuration - a.avgDuration);
                            
                            commandExecutionsHtml = `
                                <details style="margin-top: 15px; background: #f0f7ff; padding: 12px; border-radius: 6px; border: 2px solid #1976D2;">
                                    <summary style="cursor: pointer; color: #1976D2; font-weight: bold; font-size: 1.05em;">
                                        ğŸ“Š æ‰€æœ‰ Command åŸ·è¡Œè¨˜éŒ„ (${totalCommands} å€‹ä¸åŒçš„ Command)
                                        <button class="copy-btn" onclick="event.stopPropagation(); downloadCSV('${data.file_id}', this)" style="margin-left: 10px;">ä¸‹è¼‰ CSV</button>
                                        <span class="snapshot-help-icon">?
                                            <span class="tooltip-text">é¡¯ç¤ºæ‰€æœ‰æ¸¬è©¦ Command çš„åŸ·è¡Œçµ±è¨ˆè³‡è¨Šã€‚

â€¢ æŒ‰å¹³å‡åŸ·è¡Œæ™‚é–“é™åºæ’åˆ—(æœ€æ…¢çš„åœ¨æœ€ä¸Šé¢)
â€¢ é»æ“Šæ¯å€‹ Command å¯æŸ¥çœ‹è©³ç´°åŸ·è¡Œè¨˜éŒ„
â€¢ åŒ…å«æ¯æ¬¡åŸ·è¡Œçš„ Groupã€Roundã€æ™‚é–“ã€çµæœå’Œæº«åº¦
â€¢ å¯ä¸‹è¼‰ CSV æª”æ¡ˆé€²è¡Œé€²ä¸€æ­¥åˆ†æ</span>
                                        </span>
                                    </summary>
                                    <div style="margin-top: 12px;">
                                        ${commandsWithAvg.map(({ cmd, executions, avgDuration }) => {
                                            const failCount = executions.filter(e => e.result === 'Fail').length;
                                            const passCount = executions.filter(e => e.result === 'Pass').length;
                                            const exceptionCount = executions.filter(e => e.result === 'Exception').length;
                                            const avgDurationStr = avgDuration > 0 ? `å¹³å‡ ${avgDuration.toFixed(2)}s` : 'ç„¡æ™‚é–“è³‡æ–™';
                                            
                                            // åªé¡¯ç¤ºéé›¶çš„çµæœçµ±è¨ˆ
                                            let resultStats = [];
                                            if (passCount > 0) resultStats.push(`<span style="color: green;">Pass: ${passCount}</span>`);
                                            if (failCount > 0) resultStats.push(`<span style="color: red;">Fail: ${failCount}</span>`);
                                            if (exceptionCount > 0) resultStats.push(`<span style="color: orange;">Exception: ${exceptionCount}</span>`);
                                            const resultStatsStr = resultStats.join(' | ');
                                            
                                            return `
                                                <details style="margin-bottom: 10px; background: white; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                                                    <summary style="cursor: pointer; font-weight: bold;">
                                                        <code style="background: #e8e8e8; padding: 2px 6px; border-radius: 3px;">${cmd}</code>
                                                        <span style="margin-left: 10px; font-size: 0.9em;">
                                                            <span style="background: #fff3cd; padding: 2px 6px; border-radius: 3px; color: #856404;">${avgDurationStr}</span> |
                                                            åŸ·è¡Œ ${executions.length} æ¬¡ - 
                                                            ${resultStatsStr}
                                                        </span>
                                                    </summary>
                                                    <div style="margin-top: 8px; max-height: 300px; overflow-y: auto;">
                                                        <table style="width: 100%; font-size: 0.85em; border-collapse: collapse;">
                                                            <thead>
                                                                <tr style="background: #e0e0e0;">
                                                                    <th style="padding: 6px; border: 1px solid #ccc;">Group</th>
                                                                    <th style="padding: 6px; border: 1px solid #ccc;">Round</th>
                                                                    <th style="padding: 6px; border: 1px solid #ccc;">Start Time</th>
                                                                    <th style="padding: 6px; border: 1px solid #ccc;">Duration (s)</th>
                                                                    <th style="padding: 6px; border: 1px solid #ccc;">Result</th>
                                                                    <th style="padding: 6px; border: 1px solid #ccc;">Temp (Â°C)</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                ${executions.map(exec => {
                                                                    const resultColor = exec.result === 'Pass' ? 'green' : (exec.result === 'Fail' ? 'red' : 'orange');
                                                                    const durationStr = exec.duration ? exec.duration.toFixed(2) : 'N/A';
                                                                    const tempStr = exec.temperature || '-';
                                                                    return `
                                                                        <tr>
                                                                            <td style="padding: 6px; border: 1px solid #ccc;">${exec.group}</td>
                                                                            <td style="padding: 6px; border: 1px solid #ccc; text-align: center;">${exec.round}</td>
                                                                            <td style="padding: 6px; border: 1px solid #ccc;">${exec.start_time}</td>
                                                                            <td style="padding: 6px; border: 1px solid #ccc; text-align: right;">${durationStr}</td>
                                                                            <td style="padding: 6px; border: 1px solid #ccc; color: ${resultColor}; font-weight: bold;">${exec.result}</td>
                                                                            <td style="padding: 6px; border: 1px solid #ccc; text-align: right;">${tempStr}</td>
                                                                        </tr>
                                                                    `;
                                                                }).join('')}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </details>
                                            `;
                                        }).join('')}
                                    </div>
                                </details>
                            `;
                        }
                        
                        // å»ºç«‹å¤±æ•—é …ç›® HTML
                        let failedHtml = '';
                        if (data.failed_summaries && data.failed_summaries.length > 0) {
                            failedHtml = '<div style="margin-top: 10px;"><strong>å¤±æ•—é …ç›®:</strong></div>';
                            data.failed_summaries.forEach((fail, idx) => {
                                let tempBadge = '';
                                if (fail.temperature) {
                                    let tempClass = 'temp-hot'; // é è¨­ç‚™ç†±
                                    if (fail.temperature < 25) {
                                        tempClass = 'temp-cold'; // å†°å†·
                                    } else if (fail.temperature <= 55) {
                                        tempClass = 'temp-normal'; // å¸¸æº«
                                    }
                                    tempBadge = `<span class="temp-badge ${tempClass}">${fail.temperature} Â°C</span>`;
                                }
                                
                                failedHtml += `
                                    <div class="fail-item">
                                        <strong>#${idx + 1} ${fail.command}</strong> ${tempBadge}<br>
                                        <small>Group: ${fail.group} | Round: ${fail.round} | Time: ${fail.start_time}</small>
                                        <details style="margin-top: 5px;">
                                            <summary style="cursor: pointer; color: #1976D2;">
                                                æŸ¥çœ‹å®Œæ•´ Log
                                                <button class="copy-btn" onclick="event.stopPropagation(); copyLog(this, 'log-${data.file_id}-${idx}')">è¤‡è£½</button>
                                            </summary>
                                            <pre id="log-${data.file_id}-${idx}" style="font-size: 0.85em; max-height: 300px; overflow-y: auto;">${fail.log_full}</pre>
                                        </details>
                                    </div>
                                `;
                            });
                        }
                        
                        // çµ„åˆå®Œæ•´ HTML
                        div.innerHTML = `
                            <span class="upload-time">Upload time:<br>${data.upload_time}</span>
                            <div class="file-header" onclick="toggleContent('${data.file_id}')">
                                <h3>
                                    <span class="toggle-icon collapsed" id="icon-${data.file_id}">â–¼</span>${data.filename}
                                    ${data.test_info.failed > 0 ? `<span class="fail-count">(${data.test_info.failed} fail)</span>` : ''}
                                </h3>
                            </div>
                            <div class="file-content collapsed" id="content-${data.file_id}">
                                ${summaryHtml}
                                ${commandExecutionsHtml}
                                ${failedHtml}
                                <div class="button-group" style="margin-top: 15px; position: relative;">
                                    <button class="download-btn" onclick="download('${data.file_id}')" title="ä¸‹è¼‰åŸå§‹ log æª”æ¡ˆ">
                                        ${data.download_name}
                                    </button>
                                    ${data.has_fail_report ? 
                                        `<button class="download-btn" style="background: #ff5722;" onclick="downloadFailReport('${data.file_id}')" title="çµ±æ•´ log ä¸­çš„æ‰€æœ‰ fail å€å¡Š">
                                            ä¸‹è¼‰ Fail Report
                                        </button>` : ''}
                                    <button class="clear-btn" onclick="clearFile('${data.file_id}')" style="position: absolute; bottom: 0; right: 0;" title="ç§»é™¤æ­¤çµ±è¨ˆé …ç›®æŠ˜ç–Š">
                                        æ¸…é™¤
                                    </button>
                                </div>
                            </div>
                        `;
                        results.insertBefore(div, results.firstChild);
                        updateSnapshotButton(); // æ›´æ–°å¿«ç…§æŒ‰éˆ•é¡¯ç¤ºç‹€æ…‹
                    } else {
                        alert('ä¸Šå‚³å¤±æ•—: ' + data.error);
                    }
                });
        }

        function toggleContent(fileId) {
            const content = document.getElementById('content-' + fileId);
            const icon = document.getElementById('icon-' + fileId);
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                content.classList.add('collapsed');
                icon.classList.add('collapsed');
            } else {
                content.classList.remove('collapsed');
                content.classList.add('expanded');
                icon.classList.remove('collapsed');
            }
        }

        function expandAll() {
            document.querySelectorAll('.file-content').forEach(content => {
                content.classList.remove('collapsed');
                content.classList.add('expanded');
            });
            document.querySelectorAll('.toggle-icon').forEach(icon => {
                icon.classList.remove('collapsed');
            });
        }

        function collapseAll() {
            document.querySelectorAll('.file-content').forEach(content => {
                content.classList.remove('expanded');
                content.classList.add('collapsed');
            });
            document.querySelectorAll('.toggle-icon').forEach(icon => {
                icon.classList.add('collapsed');
            });
        }

        function download(fileId) {
            window.location.href = '/download/' + fileId;
        }

        function downloadFailReport(fileId) {
            window.location.href = '/download_fail_report/' + fileId;
        }
        
        function downloadCSV(fileId, button) {
            // å¾ DOM ä¸­å–å¾—è©² fileId çš„ command_executions è³‡æ–™
            const fileElement = document.getElementById('file-' + fileId);
            if (!fileElement) {
                alert('æ‰¾ä¸åˆ°æª”æ¡ˆè³‡æ–™');
                return;
            }
            
            // ç²å–æ­£ç¢ºçš„ CSV æª”å
            const csvFileName = fileElement.dataset.csvName || 'time_stat.csv';
            
            // å¾å…¨å±€è®Šæ•¸æˆ–é‡æ–°å¾ data å–å¾—ï¼ˆéœ€è¦å¾Œç«¯æ”¯æ´ï¼‰
            fetch('/download_csv/' + fileId)
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = csvFileName;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                })
                .catch(err => {
                    alert('ä¸‹è¼‰ CSV å¤±æ•—: ' + err);
                });
        }

        function clearFile(fileId) {
            const element = document.getElementById('file-' + fileId);
            if (element) {
                element.remove();
                updateSnapshotButton(); // æ›´æ–°å¿«ç…§æŒ‰éˆ•é¡¯ç¤ºç‹€æ…‹
            }
        }

        function copyLog(button, logId) {
            const logElement = document.getElementById(logId);
            const text = logElement.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = 'âœ“ å·²è¤‡è£½';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                alert('è¤‡è£½å¤±æ•—: ' + err);
            });
        }
        
        function downloadSnapshot() {
            // è¤‡è£½ç•¶å‰é é¢çš„ HTMLï¼ˆä½¿ç”¨ true é€²è¡Œæ·±åº¦è¤‡è£½ï¼‰
            const htmlContent = document.documentElement.cloneNode(true);
            
            // ç§»é™¤ä¸Šå‚³å€åŸŸå’Œæ§åˆ¶é¢æ¿ï¼ˆé€™äº›æ˜¯æ¨¡æ¿ä¸­çš„éœæ…‹å…ƒç´ ï¼‰
            const dropzone = htmlContent.querySelector('#dropzone');
            const fileInput = htmlContent.querySelector('#fileInput');
            const controlPanel = htmlContent.querySelector('.control-panel');
            const snapshotBtn = htmlContent.querySelector('.snapshot-btn');
            const h1 = htmlContent.querySelector('h1');
            
            if (dropzone) dropzone.remove();
            if (fileInput) fileInput.remove();
            if (controlPanel) controlPanel.remove();
            if (snapshotBtn) snapshotBtn.remove();
            if (h1) h1.textContent = 'ALE Log Analysis Report (Snapshot)';
            
            // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•ï¼ˆä½†ä¿ç•™æŠ˜ç–ŠåŠŸèƒ½ï¼‰
            htmlContent.querySelectorAll('.download-btn, .clear-btn, .copy-btn').forEach(btn => btn.remove());
            
            // ç§»é™¤ä¸Šå‚³ç›¸é—œçš„äº‹ä»¶è™•ç†å™¨ï¼Œä½†ä¿ç•™ toggleContent
            const scripts = htmlContent.querySelectorAll('script');
            scripts.forEach(script => {
                const scriptText = script.textContent;
                // åªä¿ç•™å¿…è¦çš„ toggleContent å‡½æ•¸å’Œç›¸é—œåŠŸèƒ½
                if (scriptText.includes('uploadFile') || scriptText.includes('downloadCSV') || 
                    scriptText.includes('download(') || scriptText.includes('downloadFailReport') ||
                    scriptText.includes('clearFile') || scriptText.includes('copyLog') ||
                    scriptText.includes('updateSnapshotButton') || scriptText.includes('downloadSnapshot')) {
                    // ç§»é™¤ä¸éœ€è¦çš„å‡½æ•¸ï¼Œä½†ä¿ç•™ toggleContent, expandAll, collapseAll
                    const essentialScript = `
                        function toggleContent(fileId) {
                            const content = document.getElementById('content-' + fileId);
                            const icon = document.getElementById('icon-' + fileId);
                            
                            if (content.classList.contains('expanded')) {
                                content.classList.remove('expanded');
                                content.classList.add('collapsed');
                                icon.classList.add('collapsed');
                            } else {
                                content.classList.remove('collapsed');
                                content.classList.add('expanded');
                                icon.classList.remove('collapsed');
                            }
                        }

                        function expandAll() {
                            document.querySelectorAll('.file-content').forEach(content => {
                                content.classList.remove('collapsed');
                                content.classList.add('expanded');
                            });
                            document.querySelectorAll('.toggle-icon').forEach(icon => {
                                icon.classList.remove('collapsed');
                            });
                        }

                        function collapseAll() {
                            document.querySelectorAll('.file-content').forEach(content => {
                                content.classList.remove('expanded');
                                content.classList.add('collapsed');
                            });
                            document.querySelectorAll('.toggle-icon').forEach(icon => {
                                icon.classList.add('collapsed');
                            });
                        }
                    `;
                    script.textContent = essentialScript;
                } else {
                    script.remove();
                }
            });
            
            // æ›´æ–°æ¨™é¡Œ
            const title = htmlContent.querySelector('title');
            if (title) {
                title.textContent = 'ALE Log Analysis Report - ' + new Date().toLocaleString('zh-TW');
            }
            
            // åœ¨é ‚éƒ¨æ·»åŠ å¿«ç…§è³‡è¨Šå’Œæ§åˆ¶æŒ‰éˆ•
            const body = htmlContent.querySelector('body');
            if (body) {
                const infoDiv = document.createElement('div');
                infoDiv.style.cssText = 'background: #fff3cd; padding: 15px; margin: 20px 0; border-left: 4px solid #ffc107; border-radius: 4px;';
                infoDiv.innerHTML = `
                    <strong>ğŸ“¸ é é¢å¿«ç…§</strong><br>
                    <small>ç”Ÿæˆæ™‚é–“: ${new Date().toLocaleString('zh-TW')}</small><br>
                    <small>æ­¤ç‚ºéœæ…‹å¿«ç…§ï¼Œåƒ…ä¾›é–±è®€ã€‚æª”æ¡ˆæ•¸é‡: ${document.getElementById('results').children.length}</small>
                    <div style="margin-top: 10px;">
                        <button class="control-btn" onclick="expandAll()">å…¨éƒ¨å±•é–‹</button>
                        <button class="control-btn" onclick="collapseAll()">å…¨éƒ¨æ”¶åˆ</button>
                    </div>
                `;
                body.insertBefore(infoDiv, body.firstChild);
            }
            
            // ç”Ÿæˆå®Œæ•´çš„ HTML å­—ä¸²
            const htmlString = '<!DOCTYPE html>\n' + htmlContent.outerHTML;
            
            // å»ºç«‹ä¸‹è¼‰é€£çµ
            const blob = new Blob([htmlString], { type: 'text/html;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            // æ ¼å¼åŒ–æ™‚é–“ç‚º YYYY-MM-DD_HH-MM-SS
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const timestamp = `${year}-${month}-${day}_${hours}-${minutes}-${seconds}`;
            
            a.download = `ale_log_report_${timestamp}.html`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }
    </script>
</body>
</html>

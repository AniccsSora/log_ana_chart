<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ALE Log Analyzer</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ…°ï¸</text></svg>">
    <script src="{{ url_for('static', filename='chart.min.js') }}"></script>
    <style>
        body { font-family: Arial; max-width: 800px; margin: 50px auto; padding: 20px; }
        #dropzone { border: 3px dashed #ccc; padding: 50px; text-align: center; margin: 20px 0; cursor: pointer; transition: all 0.3s; }
        #dropzone:hover { border-color: #666; background: #fafafa; }
        #dropzone.hover { border-color: #333; background: #f0f0f0; }
        .file-info { background: #f9f9f9; padding: 15px; margin: 10px 0; border-left: 4px solid #4CAF50; position: relative; }
        .file-info.status-pass { border-left-color: #4CAF50; }
        .file-info.status-fail { border-left-color: #f44336; }
        .file-info.status-unknown { border-left-color: #FF9800; }
        .upload-time { 
            position: absolute; 
            top: 10px; 
            right: 15px; 
            font-size: 0.75em; 
            color: #666; 
            text-align: right;
            line-height: 1.4;
        }
        .download-btn { background: #4CAF50; color: white; padding: 10px 20px; border: none; cursor: pointer; margin: 5px; border-radius: 4px; }
        .download-btn:hover { background: #45a049; }
        .clear-btn { background: #f44336; color: white; padding: 8px 16px; border: none; cursor: pointer; margin: 5px; border-radius: 4px; }
        .clear-btn:hover { background: #da190b; }
        pre { background: #f4f4f4; padding: 10px; overflow-x: auto; }
        .button-group { margin-top: 10px; }
        .control-panel { margin: 20px 0; text-align: center; }
        .control-btn { background: #2196F3; color: white; padding: 10px 20px; border: none; cursor: pointer; margin: 0 5px; border-radius: 4px; }
        .control-btn:hover { background: #0b7dda; }
        .file-content { overflow: hidden; transition: max-height 0.3s ease; }
        .file-content.collapsed { max-height: 0; }
        .file-content.expanded { max-height: 5000px; }
        .file-header { cursor: pointer; user-select: none; }
        .file-header:hover { background: #f0f0f0; }
        .toggle-icon { display: inline-block; margin-right: 5px; transition: transform 0.3s; }
        .toggle-icon.collapsed { transform: rotate(-90deg); }
        .fail-count { color: #f44336; font-weight: bold; margin-left: 10px; font-size: 0.9em; }
        .test-summary { background: #e3f2fd; padding: 10px; margin: 10px 0; border-radius: 4px; font-size: 0.9em; }
        .test-summary strong { color: #1976D2; }
        .fail-item { background: #ffebee; padding: 10px; margin: 5px 0; border-left: 3px solid #f44336; }
        .fail-item strong { color: #c62828; }
        .temp-badge { color: white; padding: 2px 8px; border-radius: 3px; font-size: 0.85em; }
        .temp-cold { background: #2196F3; }
        .temp-normal { background: #4CAF50; }
        .temp-hot { background: #ff5722; }
        .copy-btn { background: #607D8B; color: white; padding: 4px 12px; border: none; cursor: pointer; border-radius: 3px; font-size: 0.85em; margin-left: 10px; }
        .copy-btn:hover { background: #455A64; }
        .copy-btn.copied { background: #4CAF50; }
        .help-icon { 
            display: inline-block;
            width: 18px;
            height: 18px;
            background: #2196F3;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 18px;
            font-size: 0.8em;
            margin-left: 8px;
            cursor: help;
            font-weight: bold;
        }
        .help-icon:hover { 
            background: #1976D2;
            cursor: none;
        }
        .snapshot-help-icon {
            display: inline-block;
            width: 22px;
            height: 22px;
            background: #2196F3;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 22px;
            font-size: 0.9em;
            margin-left: 8px;
            cursor: help;
            font-weight: bold;
        }
        .snapshot-help-icon:hover { 
            background: #1976D2;
        }
        .snapshot-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #9C27B0;
            color: white;
            padding: 15px 25px;
            border: none;
            cursor: pointer;
            border-radius: 50px;
            font-size: 1em;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            z-index: 1000;
            transition: all 0.3s;
        }
        .snapshot-btn:hover {
            background: #7B1FA2;
            transform: scale(1.05);
        }
        .snapshot-btn .btn-icon {
            display: none;
        }
        
        /* ç•¶è¢å¹•å¯¬åº¦å°æ–¼ 1082px æ™‚,åªé¡¯ç¤ºåœ“å½¢åœ–æ¨™ */
        @media (max-width: 1082px) {
            .snapshot-btn {
                width: 50px;
                height: 50px;
                padding: 0;
                border-radius: 50%;
                font-size: 1.5em;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .snapshot-btn .btn-text,
            .snapshot-btn .snapshot-help-icon {
                display: none;
            }
            .snapshot-btn .btn-icon {
                display: block;
            }
        }
    </style>
</head>
<body>
    <h1>æ‹–æ›³æª”æ¡ˆä¸Šå‚³</h1>
    <input type="file" id="fileInput" multiple style="display: none;">
    <div id="dropzone">æ‹–æ›³æª”æ¡ˆåˆ°æ­¤è™•æˆ–é»æ“Šé¸æ“‡ (æ”¯æ´å¤šæª”æ¡ˆ)</div>
    
    <div class="control-panel">
        <button class="control-btn" onclick="expandAll()">å…¨éƒ¨å±•é–‹</button>
        <button class="control-btn" onclick="collapseAll()">å…¨éƒ¨æ”¶åˆ</button>
    </div>
    
    <div id="results"></div>
    
    <button class="snapshot-btn" id="snapshotBtn" onclick="downloadSnapshot()" style="display: none;">
        <span class="btn-text">ğŸ’¾ å„²å­˜é é¢å¿«ç…§</span>
        <span class="btn-icon">ğŸ’¾</span>
        <span class="snapshot-help-icon" title="ä¸‹è¼‰ç•¶å‰é é¢çš„å®Œæ•´å‰¯æœ¬,åŒ…å«æ‰€æœ‰çµ±è¨ˆæ•¸æ“šå’Œåˆ†æçµæœã€‚&#10;&#10;â€¢ å¯é›¢ç·šæŸ¥çœ‹,ä¸ä¾è³´ä»»ä½•ä¼ºæœå™¨&#10;â€¢ ä¿ç•™æ‰€æœ‰å±•é–‹/æ”¶åˆç‹€æ…‹&#10;â€¢ ç§»é™¤ä¸Šå‚³å’Œä¸‹è¼‰åŠŸèƒ½,åƒ…ä¾›é–±è®€">?</span>
    </button>

    <script>
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');
        const results = document.getElementById('results');
        const snapshotBtn = document.getElementById('snapshotBtn');
        
        // æª¢æŸ¥æ˜¯å¦æœ‰ä¸Šå‚³çš„æª”æ¡ˆï¼Œæ§åˆ¶å¿«ç…§æŒ‰éˆ•é¡¯ç¤º
        function updateSnapshotButton() {
            const hasFiles = results.children.length > 0;
            snapshotBtn.style.display = hasFiles ? 'block' : 'none';
        }

        // é»æ“Šé–‹å•Ÿæª”æ¡ˆé¸æ“‡è¦–çª—
        dropzone.onclick = () => fileInput.click();

        // æª”æ¡ˆé¸æ“‡è¦–çª—é¸æ“‡å¾Œ
        fileInput.onchange = (e) => {
            [...e.target.files].forEach(uploadFile);
            fileInput.value = ''; // æ¸…ç©ºä»¥å…è¨±é‡è¤‡é¸æ“‡ç›¸åŒæª”æ¡ˆ
        };

        dropzone.ondragover = (e) => { e.preventDefault(); dropzone.classList.add('hover'); };
        dropzone.ondragleave = () => dropzone.classList.remove('hover');
        dropzone.ondrop = (e) => {
            e.preventDefault();
            dropzone.classList.remove('hover');
            [...e.dataTransfer.files].forEach(uploadFile);
        };

        function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            fetch('/upload', { method: 'POST', body: formData })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        const div = document.createElement('div');
                        div.className = 'file-info status-' + data.status;
                        div.id = 'file-' + data.file_id;
                        div.dataset.csvName = data.csv_download_name; // å„²å­˜ CSV æª”å
                        
                        // å»ºç«‹æ¸¬è©¦æ‘˜è¦ HTML
                        let summaryHtml = `
                            <div class="test-summary">
                                <strong>æ¸¬è©¦æ‘˜è¦:</strong>
                                é–‹å§‹æ™‚é–“: ${data.test_info.start_time || 'Unknown'} | 
                                ç¸½æ¸¬è©¦: ${data.test_info.total_sessions} | 
                                <span style="color: green;">é€šé: ${data.test_info.passed}</span> | 
                                <span style="color: red;">å¤±æ•—: ${data.test_info.failed}</span> | 
                                <span style="color: orange;">ç•°å¸¸: ${data.test_info.exception}</span>
                            </div>
                        `;
                        
                        // å»ºç«‹æ‰€æœ‰ Command åŸ·è¡Œè¨˜éŒ„çš„çµ±ä¸€æŠ˜ç–Šå€å¡Š
                        let commandExecutionsHtml = '';
                        if (data.command_executions && Object.keys(data.command_executions).length > 0) {
                            const totalCommands = Object.keys(data.command_executions).length;
                            
                            // è¨ˆç®—æ¯å€‹ Command çš„å¹³å‡åŸ·è¡Œæ™‚é–“ä¸¦æ’åº
                            const commandsWithAvg = Object.entries(data.command_executions).map(([cmd, executions]) => {
                                const validDurations = executions.filter(e => e.duration).map(e => e.duration);
                                const avgDuration = validDurations.length > 0 
                                    ? validDurations.reduce((a, b) => a + b, 0) / validDurations.length 
                                    : 0;
                                return { cmd, executions, avgDuration };
                            });
                            
                            // æŒ‰å¹³å‡åŸ·è¡Œæ™‚é–“é™åºæ’åºï¼ˆæœ€é•·çš„åœ¨ä¸Šé¢ï¼‰
                            commandsWithAvg.sort((a, b) => b.avgDuration - a.avgDuration);
                            
                            commandExecutionsHtml = `
                                <details style="margin-top: 15px; background: #f0f7ff; padding: 12px; border-radius: 6px; border: 2px solid #1976D2;">
                                    <summary style="cursor: pointer; color: #1976D2; font-weight: bold; font-size: 1.05em;">
                                        ğŸ“Š æ‰€æœ‰ Command åŸ·è¡Œè¨˜éŒ„ (${totalCommands} å€‹ä¸åŒçš„ Command)
                                        <button class="copy-btn" onclick="event.stopPropagation(); downloadCSV('${data.file_id}', this)" style="margin-left: 10px;">ä¸‹è¼‰ CSV</button>
                                        <span class="snapshot-help-icon" title="é¡¯ç¤ºæ‰€æœ‰æ¸¬è©¦ Command çš„åŸ·è¡Œçµ±è¨ˆè³‡è¨Šã€‚&#10;&#10;â€¢ æŒ‰å¹³å‡åŸ·è¡Œæ™‚é–“é™åºæ’åˆ—(æœ€æ…¢çš„åœ¨æœ€ä¸Šé¢)&#10;â€¢ é»æ“Šæ¯å€‹ Command å¯æŸ¥çœ‹è©³ç´°åŸ·è¡Œè¨˜éŒ„&#10;â€¢ åŒ…å«æ¯æ¬¡åŸ·è¡Œçš„ Groupã€Roundã€æ™‚é–“ã€çµæœå’Œæº«åº¦&#10;â€¢ å¯ä¸‹è¼‰ CSV æª”æ¡ˆé€²è¡Œé€²ä¸€æ­¥åˆ†æ">?</span>
                                    </summary>
                                    <div style="margin-top: 12px;">
                                        ${commandsWithAvg.map(({ cmd, executions, avgDuration }) => {
                                            const failCount = executions.filter(e => e.result === 'Fail').length;
                                            const passCount = executions.filter(e => e.result === 'Pass').length;
                                            const exceptionCount = executions.filter(e => e.result === 'Exception').length;
                                            const validDurations = executions.filter(e => e.duration).map(e => e.duration);
                                            const avgDurationStr = avgDuration > 0 ? `å¹³å‡ ${avgDuration.toFixed(2)}s` : 'ç„¡æ™‚é–“è³‡æ–™';
                                            
                                            // åªé¡¯ç¤ºéé›¶çš„çµæœçµ±è¨ˆ
                                            let resultStats = [];
                                            if (passCount > 0) resultStats.push(`<span style="color: green;">Pass: ${passCount}</span>`);
                                            if (failCount > 0) resultStats.push(`<span style="color: red;">Fail: ${failCount}</span>`);
                                            if (exceptionCount > 0) resultStats.push(`<span style="color: orange;">Exception: ${exceptionCount}</span>`);
                                            const resultStatsStr = resultStats.join(' | ');
                                            
                                            // è¨ˆç®—æ¨™æº–å·®
                                            let stdDev = 0;
                                            if (validDurations.length > 1) {
                                                const variance = validDurations.reduce((sum, val) => sum + Math.pow(val - avgDuration, 2), 0) / validDurations.length;
                                                stdDev = Math.sqrt(variance);
                                            }
                                            
                                            // ä½¿ç”¨ IQR æ–¹æ³•æª¢æ¸¬ç•°å¸¸å€¼
                                            let outliers = [];
                                            if (validDurations.length >= 4) {
                                                const sorted = [...validDurations].sort((a, b) => a - b);
                                                const q1Index = Math.floor(sorted.length * 0.25);
                                                const q3Index = Math.floor(sorted.length * 0.75);
                                                const q1 = sorted[q1Index];
                                                const q3 = sorted[q3Index];
                                                const iqr = q3 - q1;
                                                const lowerBound = q1 - 1.5 * iqr;
                                                const upperBound = q3 + 1.5 * iqr;
                                                
                                                executions.forEach((exec, idx) => {
                                                    if (exec.duration && (exec.duration < lowerBound || exec.duration > upperBound)) {
                                                        outliers.push({ round: exec.round, value: exec.duration });
                                                    }
                                                });
                                            }
                                            
                                            // çµ±è¨ˆè³‡è¨Šå­—ä¸²
                                            let statsInfo = '';
                                            if (validDurations.length > 0) {
                                                statsInfo = ` | Ïƒ=${stdDev.toFixed(3)}s`;
                                                if (outliers.length > 0) {
                                                    statsInfo += ` | <span style="color: #d32f2f; font-weight: bold;">âš  ${outliers.length} å€‹ç•°å¸¸å€¼</span>`;
                                                }
                                            }
                                            
                                            // ç”Ÿæˆå”¯ä¸€çš„ canvas ID
                                            const chartId = 'chart-' + data.file_id + '-' + Math.random().toString(36).substr(2, 9);
                                            
                                            // å»ºç«‹è¡¨æ ¼ HTML
                                            const tableRows = executions.map(exec => {
                                                const resultColor = exec.result === 'Pass' ? 'green' : (exec.result === 'Fail' ? 'red' : 'orange');
                                                const durationStr = exec.duration ? exec.duration.toFixed(2) : 'N/A';
                                                const tempStr = exec.temperature || '-';
                                                return '<tr>' +
                                                    '<td style="padding: 6px; border: 1px solid #ccc;">' + exec.group + '</td>' +
                                                    '<td style="padding: 6px; border: 1px solid #ccc; text-align: center;">' + exec.round + '</td>' +
                                                    '<td style="padding: 6px; border: 1px solid #ccc;">' + exec.start_time + '</td>' +
                                                    '<td style="padding: 6px; border: 1px solid #ccc; text-align: right;">' + durationStr + '</td>' +
                                                    '<td style="padding: 6px; border: 1px solid #ccc; color: ' + resultColor + '; font-weight: bold;">' + exec.result + '</td>' +
                                                    '<td style="padding: 6px; border: 1px solid #ccc; text-align: right;">' + tempStr + '</td>' +
                                                    '</tr>';
                                            }).join('');
                                            
                                            return `
                                                <details style="margin-bottom: 10px; background: white; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                                                    <summary style="cursor: pointer; font-weight: bold;">
                                                        <code style="background: #e8e8e8; padding: 2px 6px; border-radius: 3px;">${cmd}</code>
                                                        <span style="margin-left: 10px; font-size: 0.9em;">
                                                            <span style="background: #fff3cd; padding: 2px 6px; border-radius: 3px; color: #856404;">${avgDurationStr}</span>${statsInfo} |
                                                            åŸ·è¡Œ ${executions.length} æ¬¡ - 
                                                            ${resultStatsStr}
                                                        </span>
                                                    </summary>
                                                    <div style="margin-top: 8px;">
                                                        <div style="background: #f9f9f9; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
                                                            <canvas id="${chartId}" style="max-height: 200px;"></canvas>
                                                        </div>
                                                        <div style="max-height: 300px; overflow-y: auto;">
                                                            <table style="width: 100%; font-size: 0.85em; border-collapse: collapse;">
                                                                <thead>
                                                                    <tr style="background: #e0e0e0;">
                                                                        <th style="padding: 6px; border: 1px solid #ccc;">Group</th>
                                                                        <th style="padding: 6px; border: 1px solid #ccc;">Round</th>
                                                                        <th style="padding: 6px; border: 1px solid #ccc;">Start Time</th>
                                                                        <th style="padding: 6px; border: 1px solid #ccc;">Duration (s)</th>
                                                                        <th style="padding: 6px; border: 1px solid #ccc;">Result</th>
                                                                        <th style="padding: 6px; border: 1px solid #ccc;">Temp (Â°C)</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>${tableRows}</tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </details>
                                            `;
                                        }).join('')}
                                    </div>
                                </details>
                            `;
                        }
                        
                        // å»ºç«‹å¤±æ•—é …ç›® HTML
                        let failedHtml = '';
                        if (data.failed_summaries && data.failed_summaries.length > 0) {
                            failedHtml = '<div style="margin-top: 10px;"><strong>å¤±æ•—é …ç›®:</strong></div>';
                            data.failed_summaries.forEach((fail, idx) => {
                                let tempBadge = '';
                                if (fail.temperature) {
                                    let tempClass = 'temp-hot'; // é è¨­ç‚™ç†±
                                    if (fail.temperature < 25) {
                                        tempClass = 'temp-cold'; // å†°å†·
                                    } else if (fail.temperature <= 55) {
                                        tempClass = 'temp-normal'; // å¸¸æº«
                                    }
                                    tempBadge = `<span class="temp-badge ${tempClass}">${fail.temperature} Â°C</span>`;
                                }
                                
                                failedHtml += `
                                    <div class="fail-item">
                                        <strong>#${idx + 1} ${fail.command}</strong> ${tempBadge}<br>
                                        <small>Group: ${fail.group} | Round: ${fail.round} | Time: ${fail.start_time}</small>
                                        <details style="margin-top: 5px;">
                                            <summary style="cursor: pointer; color: #1976D2;">
                                                æŸ¥çœ‹å®Œæ•´ Log
                                                <button class="copy-btn" onclick="event.stopPropagation(); copyLog(this, 'log-${data.file_id}-${idx}')">è¤‡è£½</button>
                                            </summary>
                                            <pre id="log-${data.file_id}-${idx}" style="font-size: 0.85em; max-height: 300px; overflow-y: auto;">${fail.log_full}</pre>
                                        </details>
                                    </div>
                                `;
                            });
                        }
                        
                        // çµ„åˆå®Œæ•´ HTML
                        div.innerHTML = `
                            <span class="upload-time">Upload time:<br>${data.upload_time}</span>
                            <div class="file-header" onclick="toggleContent('${data.file_id}')">
                                <h3>
                                    <span class="toggle-icon collapsed" id="icon-${data.file_id}">â–¼</span>${data.filename}
                                    ${data.test_info.failed > 0 ? `<span class="fail-count">(${data.test_info.failed} fail)</span>` : ''}
                                </h3>
                            </div>
                            <div class="file-content collapsed" id="content-${data.file_id}">
                                ${summaryHtml}
                                ${commandExecutionsHtml}
                                ${failedHtml}
                                <div class="button-group" style="margin-top: 15px; position: relative;">
                                    <div style="display: inline-flex; gap: 5px; margin-right: 10px;">
                                        <button class="download-btn" onclick="viewRaw('${data.file_id}')" title="åœ¨æ–°åˆ†é æŸ¥çœ‹åŸå§‹ log å…§å®¹">
                                            Raw
                                        </button>
                                        <button class="download-btn" onclick="download('${data.file_id}')" title="ä¸‹è¼‰åŸå§‹ log æª”æ¡ˆ">
                                            ä¸‹è¼‰ Raw
                                        </button>
                                    </div>
                                    ${data.has_fail_report ? 
                                        `<button class="download-btn" style="background: #ff5722;" onclick="downloadFailReport('${data.file_id}')" title="çµ±æ•´ log ä¸­çš„æ‰€æœ‰ fail å€å¡Š">
                                            ä¸‹è¼‰ Fail Report
                                        </button>` : ''}
                                    <button class="clear-btn" onclick="clearFile('${data.file_id}')" style="position: absolute; bottom: 0; right: 0;" title="ç§»é™¤æ­¤çµ±è¨ˆé …ç›®æŠ˜ç–Š">
                                        æ¸…é™¤
                                    </button>
                                </div>
                            </div>
                        `;
                        results.insertBefore(div, results.firstChild);
                        
                        // ç‚ºæ¯å€‹ command å‰µå»ºåœ–è¡¨
                        if (data.command_executions && Object.keys(data.command_executions).length > 0) {
                            // å»¶é²åŸ·è¡Œä»¥ç¢ºä¿ DOM å·²ç¶“æ¸²æŸ“
                            setTimeout(() => {
                                const commandsWithAvg = Object.entries(data.command_executions).map(([cmd, executions]) => {
                                    const validDurations = executions.filter(e => e.duration).map(e => e.duration);
                                    const avgDuration = validDurations.length > 0 
                                        ? validDurations.reduce((a, b) => a + b, 0) / validDurations.length 
                                        : 0;
                                    return { cmd, executions, avgDuration };
                                });
                                
                                commandsWithAvg.sort((a, b) => b.avgDuration - a.avgDuration);
                                
                                const canvases = div.querySelectorAll('canvas');
                                canvases.forEach((canvas, idx) => {
                                    if (canvas && !canvas.chart && idx < commandsWithAvg.length) {
                                        const { executions } = commandsWithAvg[idx];
                                        const ctx = canvas.getContext('2d');
                                        
                                        const labels = executions.map(e => 'R' + e.round);
                                        const durations = executions.map(e => e.duration || 0);
                                        const failPoints = executions.map(e => e.result === 'Fail' ? (e.duration || 0) : null);
                                        
                                        // è¨ˆç®—å¹³å‡å€¼å’Œæ¨™æº–å·®ç”¨æ–¼åœ–è¡¨é¡¯ç¤º
                                        const validDurations = durations.filter(d => d > 0);
                                        const mean = validDurations.reduce((a, b) => a + b, 0) / validDurations.length;
                                        let stdDev = 0;
                                        if (validDurations.length > 1) {
                                            const variance = validDurations.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / validDurations.length;
                                            stdDev = Math.sqrt(variance);
                                        }
                                        
                                        // æª¢æ¸¬ç•°å¸¸å€¼
                                        const outlierPoints = [];
                                        if (validDurations.length >= 4) {
                                            const sorted = [...validDurations].sort((a, b) => a - b);
                                            const q1 = sorted[Math.floor(sorted.length * 0.25)];
                                            const q3 = sorted[Math.floor(sorted.length * 0.75)];
                                            const iqr = q3 - q1;
                                            const lowerBound = q1 - 1.5 * iqr;
                                            const upperBound = q3 + 1.5 * iqr;
                                            
                                            durations.forEach((d, i) => {
                                                if (d > 0 && (d < lowerBound || d > upperBound)) {
                                                    outlierPoints.push(d);
                                                } else {
                                                    outlierPoints.push(null);
                                                }
                                            });
                                        }
                                        
                                        canvas.chart = new Chart(ctx, {
                                            type: 'line',
                                            data: {
                                                labels: labels,
                                                datasets: [{
                                                    label: 'åŸ·è¡Œæ™‚é–“',
                                                    data: durations,
                                                    borderColor: '#2196F3',
                                                    backgroundColor: 'rgba(33, 150, 243, 0.1)',
                                                    tension: 0.3,
                                                    pointRadius: 4
                                                }, {
                                                    label: 'å¹³å‡å€¼',
                                                    data: Array(durations.length).fill(mean),
                                                    borderColor: '#4CAF50',
                                                    borderWidth: 2,
                                                    borderDash: [5, 5],
                                                    pointRadius: 0,
                                                    fill: false
                                                }, {
                                                    label: 'Â±1Ïƒ ä¸Šç•Œ',
                                                    data: Array(durations.length).fill(mean + stdDev),
                                                    borderColor: '#FFC107',
                                                    borderWidth: 1,
                                                    borderDash: [2, 2],
                                                    pointRadius: 0,
                                                    fill: false
                                                }, {
                                                    label: 'Â±1Ïƒ ä¸‹ç•Œ',
                                                    data: Array(durations.length).fill(mean - stdDev),
                                                    borderColor: '#FFC107',
                                                    borderWidth: 1,
                                                    borderDash: [2, 2],
                                                    pointRadius: 0,
                                                    fill: false
                                                }, {
                                                    label: 'ç•°å¸¸å€¼ (IQR)',
                                                    data: outlierPoints,
                                                    backgroundColor: '#FF9800',
                                                    pointRadius: 10,
                                                    pointStyle: 'triangle',
                                                    showLine: false
                                                }, {
                                                    label: 'Fail',
                                                    data: failPoints,
                                                    backgroundColor: '#f44336',
                                                    pointRadius: 8,
                                                    showLine: false
                                                }]
                                            },
                                            options: {
                                                responsive: true,
                                                maintainAspectRatio: true,
                                                aspectRatio: 2.5,
                                                plugins: {
                                                    legend: { display: true, position: 'top', labels: { boxWidth: 15, padding: 10, font: { size: 11 } } }
                                                },
                                                scales: {
                                                    y: { beginAtZero: true, ticks: { font: { size: 10 } }, title: { display: true, text: 'ç§’', font: { size: 11 } } },
                                                    x: { ticks: { font: { size: 10 } }, title: { display: true, text: 'Round', font: { size: 11 } } }
                                                }
                                            }
                                        });
                                    }
                                });
                            }, 100);
                        }
                        
                        updateSnapshotButton(); // æ›´æ–°å¿«ç…§æŒ‰éˆ•é¡¯ç¤ºç‹€æ…‹
                    } else {
                        alert('ä¸Šå‚³å¤±æ•—: ' + data.error);
                    }
                });
        }

        function toggleContent(fileId) {
            const content = document.getElementById('content-' + fileId);
            const icon = document.getElementById('icon-' + fileId);
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                content.classList.add('collapsed');
                icon.classList.add('collapsed');
            } else {
                content.classList.remove('collapsed');
                content.classList.add('expanded');
                icon.classList.remove('collapsed');
            }
        }

        function expandAll() {
            document.querySelectorAll('.file-content').forEach(content => {
                content.classList.remove('collapsed');
                content.classList.add('expanded');
            });
            document.querySelectorAll('.toggle-icon').forEach(icon => {
                icon.classList.remove('collapsed');
            });
        }

        function collapseAll() {
            document.querySelectorAll('.file-content').forEach(content => {
                content.classList.remove('expanded');
                content.classList.add('collapsed');
            });
            document.querySelectorAll('.toggle-icon').forEach(icon => {
                icon.classList.add('collapsed');
            });
        }

        function viewRaw(fileId) {
            window.open('/raw/' + fileId, '_blank');
        }

        function download(fileId) {
            window.location.href = '/download/' + fileId;
        }

        function downloadFailReport(fileId) {
            window.location.href = '/download_fail_report/' + fileId;
        }
        
        function downloadCSV(fileId, button) {
            // å¾ DOM ä¸­å–å¾—è©² fileId çš„ command_executions è³‡æ–™
            const fileElement = document.getElementById('file-' + fileId);
            if (!fileElement) {
                alert('æ‰¾ä¸åˆ°æª”æ¡ˆè³‡æ–™');
                return;
            }
            
            // ç²å–æ­£ç¢ºçš„ CSV æª”å
            const csvFileName = fileElement.dataset.csvName || 'time_stat.csv';
            
            // å¾å…¨å±€è®Šæ•¸æˆ–é‡æ–°å¾ data å–å¾—ï¼ˆéœ€è¦å¾Œç«¯æ”¯æ´ï¼‰
            fetch('/download_csv/' + fileId)
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = csvFileName;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                })
                .catch(err => {
                    alert('ä¸‹è¼‰ CSV å¤±æ•—: ' + err);
                });
        }

        function clearFile(fileId) {
            const element = document.getElementById('file-' + fileId);
            if (element) {
                element.remove();
                updateSnapshotButton(); // æ›´æ–°å¿«ç…§æŒ‰éˆ•é¡¯ç¤ºç‹€æ…‹
            }
        }

        function copyLog(button, logId) {
            const logElement = document.getElementById(logId);
            const text = logElement.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = 'âœ“ å·²è¤‡è£½';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                alert('è¤‡è£½å¤±æ•—: ' + err);
            });
        }
        
        function downloadSnapshot() {
            // ä½¿ç”¨ async IIFE (ç«‹å³åŸ·è¡Œçš„ async å‡½æ•¸)
            (async () => {
                // è¤‡è£½ç•¶å‰é é¢çš„ HTMLï¼ˆä½¿ç”¨ true é€²è¡Œæ·±åº¦è¤‡è£½ï¼‰
                const htmlContent = document.documentElement.cloneNode(true);
                
                // è™•ç† Chart.js script - å¾ server è®€å–ä¸¦åµŒå…¥
                const chartScript = htmlContent.querySelector('head script[src*="chart"]');
                let chartJsLoaded = false;
                
                if (chartScript) {
                    try {
                        // å¾ server è®€å– Chart.js å…§å®¹
                        const response = await fetch(chartScript.src);
                        const chartJsContent = await response.text();
                        
                        // åœ¨ htmlContent çš„ä¸Šä¸‹æ–‡ä¸­å‰µå»º script
                        // æ–¹æ³•1: ç›´æ¥ä¿®æ”¹ textContent (æœ€ç°¡å–®)
                        chartScript.removeAttribute('src'); // ç§»é™¤ src å±¬æ€§
                        chartScript.textContent = chartJsContent; // è¨­å®šç‚º inline script
                        chartScript.dataset.keepScript = 'true'; // æ¨™è¨˜ç‚ºéœ€è¦ä¿ç•™çš„ script
                        
                        chartJsLoaded = true;
                    } catch (err) {
                        console.warn('ç„¡æ³•è¼‰å…¥ Chart.jsï¼Œå¿«ç…§å°‡åªåŒ…å«éœæ…‹åœ–è¡¨åœ–ç‰‡', err);
                        chartScript.remove();
                    }
                }
                
                // åªæœ‰åœ¨ Chart.js è¼‰å…¥å¤±æ•—æ™‚ï¼Œæ‰å°‡ canvas è½‰æ›ç‚ºåœ–ç‰‡
                if (!chartJsLoaded) {
                    const canvases = document.querySelectorAll('canvas');
                    const clonedCanvases = htmlContent.querySelectorAll('canvas');
                    canvases.forEach((canvas, idx) => {
                        if (canvas.chart && clonedCanvases[idx]) {
                            const img = document.createElement('img');
                            img.src = canvas.toDataURL('image/png');
                            img.style.width = '100%';
                            img.style.maxHeight = '200px';
                            clonedCanvases[idx].parentNode.replaceChild(img, clonedCanvases[idx]);
                        }
                    });
                } else {
                    // Chart.js è¼‰å…¥æˆåŠŸæ™‚ï¼Œæ”¶é›†æ‰€æœ‰åœ–è¡¨é…ç½®ä¸¦æ³¨å…¥åˆ°å¿«ç…§ä¸­
                    const canvases = document.querySelectorAll('canvas');
                    const chartConfigs = {};
                    
                    canvases.forEach((canvas) => {
                        if (canvas.chart && canvas.id) {
                            // å„²å­˜åœ–è¡¨é…ç½®
                            chartConfigs[canvas.id] = {
                                labels: canvas.chart.data.labels,
                                datasets: canvas.chart.data.datasets,
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: true,
                                    aspectRatio: 2.5,
                                    plugins: {
                                        legend: { display: true, position: 'top', labels: { boxWidth: 15, padding: 10, font: { size: 11 } } }
                                    },
                                    scales: {
                                        y: { beginAtZero: true, ticks: { font: { size: 10 } }, title: { display: true, text: 'ç§’', font: { size: 11 } } },
                                        x: { ticks: { font: { size: 10 } }, title: { display: true, text: 'Round', font: { size: 11 } } }
                                    }
                                }
                            };
                        }
                    });
                    
                    // åœ¨ head ä¸­æ³¨å…¥åœ–è¡¨é…ç½®
                    const configScript = document.createElement('script');
                    configScript.textContent = `window.chartConfigs = ${JSON.stringify(chartConfigs)};`;
                    configScript.dataset.keepScript = 'true';
                    const head = htmlContent.querySelector('head');
                    if (head) {
                        head.appendChild(configScript);
                    }
                    
                    // ç§»é™¤æ‰€æœ‰ base64 åœ–ç‰‡
                    const base64Images = htmlContent.querySelectorAll('img[src^="data:image"]');
                    base64Images.forEach(img => {
                        console.log('ç§»é™¤ base64 åœ–ç‰‡:', img.src.substring(0, 50));
                        img.remove();
                    });
                }
                
                // ç§»é™¤ä¸Šå‚³å€åŸŸå’Œæ§åˆ¶é¢æ¿ï¼ˆé€™äº›æ˜¯æ¨¡æ¿ä¸­çš„éœæ…‹å…ƒç´ ï¼‰
            const dropzone = htmlContent.querySelector('#dropzone');
            const fileInput = htmlContent.querySelector('#fileInput');
            const controlPanel = htmlContent.querySelector('.control-panel');
            const snapshotBtn = htmlContent.querySelector('.snapshot-btn');
            const h1 = htmlContent.querySelector('h1');
            
            if (dropzone) dropzone.remove();
            if (fileInput) fileInput.remove();
            if (controlPanel) controlPanel.remove();
            if (snapshotBtn) snapshotBtn.remove();
            if (h1) h1.textContent = 'ALE Log Analysis Report (Snapshot)';
            
            // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•ï¼ˆä½†ä¿ç•™æŠ˜ç–ŠåŠŸèƒ½ï¼‰
            htmlContent.querySelectorAll('.download-btn, .clear-btn, .copy-btn').forEach(btn => btn.remove());
            
            // ç§»é™¤ä¸Šå‚³ç›¸é—œçš„äº‹ä»¶è™•ç†å™¨ï¼Œä½†ä¿ç•™ toggleContent
            const scripts = htmlContent.querySelectorAll('script');
            scripts.forEach(script => {
                // ä¿ç•™æ¨™è¨˜ç‚º keepScript çš„ script (ä¾‹å¦‚ Chart.js)
                if (script.dataset.keepScript === 'true') {
                    return; // è·³é,ä¸è™•ç†
                }
                
                const scriptText = script.textContent;
                // åªä¿ç•™å¿…è¦çš„ toggleContent å‡½æ•¸å’Œç›¸é—œåŠŸèƒ½
                if (scriptText.includes('uploadFile') || scriptText.includes('downloadCSV') || 
                    scriptText.includes('download(') || scriptText.includes('downloadFailReport') ||
                    scriptText.includes('clearFile') || scriptText.includes('copyLog') ||
                    scriptText.includes('updateSnapshotButton') || scriptText.includes('downloadSnapshot')) {
                    // ç§»é™¤ä¸éœ€è¦çš„å‡½æ•¸ï¼Œä½†ä¿ç•™ toggleContent, expandAll, collapseAll
                    // ä¸¦æ·»åŠ åœ–è¡¨åˆå§‹åŒ–é‚è¼¯
                    const essentialScript = `
                        function toggleContent(fileId) {
                            const content = document.getElementById('content-' + fileId);
                            const icon = document.getElementById('icon-' + fileId);
                            
                            if (content.classList.contains('expanded')) {
                                content.classList.remove('expanded');
                                content.classList.add('collapsed');
                                icon.classList.add('collapsed');
                            } else {
                                content.classList.remove('collapsed');
                                content.classList.add('expanded');
                                icon.classList.remove('collapsed');
                            }
                        }

                        function expandAll() {
                            document.querySelectorAll('.file-content').forEach(content => {
                                content.classList.remove('collapsed');
                                content.classList.add('expanded');
                            });
                            document.querySelectorAll('.toggle-icon').forEach(icon => {
                                icon.classList.remove('collapsed');
                            });
                        }

                        function collapseAll() {
                            document.querySelectorAll('.file-content').forEach(content => {
                                content.classList.remove('expanded');
                                content.classList.add('collapsed');
                            });
                            document.querySelectorAll('.toggle-icon').forEach(icon => {
                                icon.classList.add('collapsed');
                            });
                        }
                        
                        // åˆå§‹åŒ–æ‰€æœ‰åœ–è¡¨
                        window.addEventListener('DOMContentLoaded', function() {
                            // æª¢æŸ¥æ˜¯å¦æœ‰é å…ˆå„²å­˜çš„åœ–è¡¨é…ç½®
                            if (!window.chartConfigs) {
                                console.warn('æ²’æœ‰æ‰¾åˆ°åœ–è¡¨é…ç½®ï¼Œå¿«ç…§å¯èƒ½ç„¡æ³•é¡¯ç¤ºåœ–è¡¨');
                                return;
                            }
                            
                            const canvases = document.querySelectorAll('canvas');
                            canvases.forEach(canvas => {
                                if (canvas.chart) return; // å·²ç¶“åˆå§‹åŒ–é
                                
                                const canvasId = canvas.id;
                                const config = window.chartConfigs[canvasId];
                                
                                if (!config) {
                                    console.warn('æ‰¾ä¸åˆ° canvas', canvasId, 'çš„åœ–è¡¨é…ç½®');
                                    return;
                                }
                                
                                try {
                                    const ctx = canvas.getContext('2d');
                                    canvas.chart = new Chart(ctx, {
                                        type: 'line',
                                        data: {
                                            labels: config.labels,
                                            datasets: config.datasets
                                        },
                                        options: config.options
                                    });
                                    console.log('æˆåŠŸåˆå§‹åŒ–åœ–è¡¨:', canvasId);
                                } catch (err) {
                                    console.error('åœ–è¡¨åˆå§‹åŒ–å¤±æ•—:', canvasId, err);
                                }
                            });
                        });
                    `;
                    script.textContent = essentialScript;
                } else {
                    script.remove();
                }
            });
            
            // æ›´æ–°æ¨™é¡Œ
            const title = htmlContent.querySelector('title');
            if (title) {
                title.textContent = 'ALE Log Analysis Report - ' + new Date().toLocaleString('zh-TW');
            }
            
            // åœ¨é ‚éƒ¨æ·»åŠ å¿«ç…§è³‡è¨Šå’Œæ§åˆ¶æŒ‰éˆ•
            const body = htmlContent.querySelector('body');
            if (body) {
                const infoDiv = document.createElement('div');
                infoDiv.style.cssText = 'background: #fff3cd; padding: 15px; margin: 20px 0; border-left: 4px solid #ffc107; border-radius: 4px;';
                infoDiv.innerHTML = `
                    <strong>ğŸ“¸ é é¢å¿«ç…§</strong><br>
                    <small>ç”Ÿæˆæ™‚é–“: ${new Date().toLocaleString('zh-TW')}</small><br>
                    <small>æ­¤ç‚ºéœæ…‹å¿«ç…§ï¼Œåƒ…ä¾›é–±è®€ã€‚æª”æ¡ˆæ•¸é‡: ${document.getElementById('results').children.length}</small>
                    <div style="margin-top: 10px;">
                        <button class="control-btn" onclick="expandAll()">å…¨éƒ¨å±•é–‹</button>
                        <button class="control-btn" onclick="collapseAll()">å…¨éƒ¨æ”¶åˆ</button>
                    </div>
                `;
                body.insertBefore(infoDiv, body.firstChild);
            }
            
            // ç”Ÿæˆå®Œæ•´çš„ HTML å­—ä¸²
            const htmlString = '<!DOCTYPE html>\n' + htmlContent.outerHTML;
            
            // å»ºç«‹ä¸‹è¼‰é€£çµ
            const blob = new Blob([htmlString], { type: 'text/html;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            // æ ¼å¼åŒ–æ™‚é–“ç‚º YYYY-MM-DD_HH-MM-SS
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const timestamp = `${year}-${month}-${day}_${hours}-${minutes}-${seconds}`;
            
            a.download = `ale_log_report_${timestamp}.html`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            })(); // çµæŸ async IIFE
        }
    </script>
</body>
</html>

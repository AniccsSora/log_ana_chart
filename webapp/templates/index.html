<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ALE Log Analyzer</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ…°ï¸</text></svg>">
    <style>
        body { font-family: Arial; max-width: 800px; margin: 50px auto; padding: 20px; }
        #dropzone { border: 3px dashed #ccc; padding: 50px; text-align: center; margin: 20px 0; cursor: pointer; transition: all 0.3s; }
        #dropzone:hover { border-color: #666; background: #fafafa; }
        #dropzone.hover { border-color: #333; background: #f0f0f0; }
        .file-info { background: #f9f9f9; padding: 15px; margin: 10px 0; border-left: 4px solid #4CAF50; position: relative; }
        .file-info.status-pass { border-left-color: #4CAF50; }
        .file-info.status-fail { border-left-color: #f44336; }
        .file-info.status-unknown { border-left-color: #FF9800; }
        .upload-time { position: absolute; top: 10px; right: 15px; font-size: 0.75em; color: #666; }
        .download-btn { background: #4CAF50; color: white; padding: 10px 20px; border: none; cursor: pointer; margin: 5px; border-radius: 4px; }
        .download-btn:hover { background: #45a049; }
        .clear-btn { background: #f44336; color: white; padding: 8px 16px; border: none; cursor: pointer; margin: 5px; border-radius: 4px; }
        .clear-btn:hover { background: #da190b; }
        pre { background: #f4f4f4; padding: 10px; overflow-x: auto; }
        .button-group { margin-top: 10px; }
        .control-panel { margin: 20px 0; text-align: center; }
        .control-btn { background: #2196F3; color: white; padding: 10px 20px; border: none; cursor: pointer; margin: 0 5px; border-radius: 4px; }
        .control-btn:hover { background: #0b7dda; }
        .file-content { overflow: hidden; transition: max-height 0.3s ease; }
        .file-content.collapsed { max-height: 0; }
        .file-content.expanded { max-height: 5000px; }
        .file-header { cursor: pointer; user-select: none; }
        .file-header:hover { background: #f0f0f0; }
        .toggle-icon { display: inline-block; margin-right: 5px; transition: transform 0.3s; }
        .toggle-icon.collapsed { transform: rotate(-90deg); }
        .fail-count { color: #f44336; font-weight: bold; margin-left: 10px; font-size: 0.9em; }
        .test-summary { background: #e3f2fd; padding: 10px; margin: 10px 0; border-radius: 4px; font-size: 0.9em; }
        .test-summary strong { color: #1976D2; }
        .fail-item { background: #ffebee; padding: 10px; margin: 5px 0; border-left: 3px solid #f44336; }
        .fail-item strong { color: #c62828; }
        .temp-badge { color: white; padding: 2px 8px; border-radius: 3px; font-size: 0.85em; }
        .temp-cold { background: #2196F3; }
        .temp-normal { background: #4CAF50; }
        .temp-hot { background: #ff5722; }
        .copy-btn { background: #607D8B; color: white; padding: 4px 12px; border: none; cursor: pointer; border-radius: 3px; font-size: 0.85em; margin-left: 10px; }
        .copy-btn:hover { background: #455A64; }
        .copy-btn.copied { background: #4CAF50; }
    </style>
</head>
<body>
    <h1>æ‹–æ›³æª”æ¡ˆä¸Šå‚³</h1>
    <input type="file" id="fileInput" multiple style="display: none;">
    <div id="dropzone">æ‹–æ›³æª”æ¡ˆåˆ°æ­¤è™•æˆ–é»æ“Šé¸æ“‡ (æ”¯æ´å¤šæª”æ¡ˆ)</div>
    
    <div class="control-panel">
        <button class="control-btn" onclick="expandAll()">å…¨éƒ¨å±•é–‹</button>
        <button class="control-btn" onclick="collapseAll()">å…¨éƒ¨æ”¶åˆ</button>
    </div>
    
    <div id="results"></div>

    <script>
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');
        const results = document.getElementById('results');

        // é»æ“Šé–‹å•Ÿæª”æ¡ˆé¸æ“‡è¦–çª—
        dropzone.onclick = () => fileInput.click();

        // æª”æ¡ˆé¸æ“‡è¦–çª—é¸æ“‡å¾Œ
        fileInput.onchange = (e) => {
            [...e.target.files].forEach(uploadFile);
            fileInput.value = ''; // æ¸…ç©ºä»¥å…è¨±é‡è¤‡é¸æ“‡ç›¸åŒæª”æ¡ˆ
        };

        dropzone.ondragover = (e) => { e.preventDefault(); dropzone.classList.add('hover'); };
        dropzone.ondragleave = () => dropzone.classList.remove('hover');
        dropzone.ondrop = (e) => {
            e.preventDefault();
            dropzone.classList.remove('hover');
            [...e.dataTransfer.files].forEach(uploadFile);
        };

        function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            fetch('/upload', { method: 'POST', body: formData })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        const div = document.createElement('div');
                        div.className = 'file-info status-' + data.status;
                        div.id = 'file-' + data.file_id;
                        
                        // å»ºç«‹æ¸¬è©¦æ‘˜è¦ HTML
                        let summaryHtml = `
                            <div class="test-summary">
                                <strong>æ¸¬è©¦æ‘˜è¦:</strong>
                                é–‹å§‹æ™‚é–“: ${data.test_info.start_time || 'Unknown'} | 
                                ç¸½æ¸¬è©¦: ${data.test_info.total_sessions} | 
                                <span style="color: green;">é€šé: ${data.test_info.passed}</span> | 
                                <span style="color: red;">å¤±æ•—: ${data.test_info.failed}</span> | 
                                <span style="color: orange;">ç•°å¸¸: ${data.test_info.exception}</span>
                            </div>
                        `;
                        
                        // å»ºç«‹å¤±æ•—é …ç›® HTML
                        let failedHtml = '';
                        if (data.failed_summaries && data.failed_summaries.length > 0) {
                            failedHtml = '<div style="margin-top: 10px;"><strong>å¤±æ•—é …ç›®:</strong></div>';
                            data.failed_summaries.forEach((fail, idx) => {
                                let tempBadge = '';
                                if (fail.temperature) {
                                    let tempClass = 'temp-hot'; // é è¨­ç‚™ç†±
                                    if (fail.temperature < 25) {
                                        tempClass = 'temp-cold'; // å†°å†·
                                    } else if (fail.temperature <= 55) {
                                        tempClass = 'temp-normal'; // å¸¸æº«
                                    }
                                    tempBadge = `<span class="temp-badge ${tempClass}">${fail.temperature} Â°C</span>`;
                                }
                                failedHtml += `
                                    <div class="fail-item">
                                        <strong>#${idx + 1} ${fail.command}</strong> ${tempBadge}<br>
                                        <small>Group: ${fail.group} | Round: ${fail.round} | Time: ${fail.start_time}</small>
                                        <details style="margin-top: 5px;">
                                            <summary style="cursor: pointer; color: #1976D2;">
                                                æŸ¥çœ‹å®Œæ•´ Log
                                                <button class="copy-btn" onclick="event.stopPropagation(); copyLog(this, 'log-${data.file_id}-${idx}')">è¤‡è£½</button>
                                            </summary>
                                            <pre id="log-${data.file_id}-${idx}" style="font-size: 0.85em; max-height: 300px; overflow-y: auto;">${fail.log_full}</pre>
                                        </details>
                                    </div>
                                `;
                            });
                        }
                        
                        // çµ„åˆå®Œæ•´ HTML
                        div.innerHTML = `
                            <span class="upload-time">${data.upload_time}</span>
                            <div class="file-header" onclick="toggleContent('${data.file_id}')">
                                <h3>
                                    <span class="toggle-icon collapsed" id="icon-${data.file_id}">â–¼</span>${data.filename}
                                    ${data.test_info.failed > 0 ? `<span class="fail-count">(${data.test_info.failed} fail)</span>` : ''}
                                </h3>
                            </div>
                            <div class="file-content collapsed" id="content-${data.file_id}">
                                ${summaryHtml}
                                ${failedHtml}
                                <div class="button-group" style="margin-top: 15px; position: relative;">
                                    <button class="download-btn" onclick="download('${data.file_id}')">
                                        ${data.download_name}
                                    </button>
                                    ${data.has_fail_report ? 
                                        `<button class="download-btn" style="background: #ff5722;" onclick="downloadFailReport('${data.file_id}')">
                                            ä¸‹è¼‰ Fail Report
                                        </button>` : ''}
                                    <button class="clear-btn" onclick="clearFile('${data.file_id}')" style="position: absolute; bottom: 0; right: 0;">
                                        æ¸…é™¤
                                    </button>
                                </div>
                            </div>
                        `;
                        results.insertBefore(div, results.firstChild);
                    } else {
                        alert('ä¸Šå‚³å¤±æ•—: ' + data.error);
                    }
                });
        }

        function toggleContent(fileId) {
            const content = document.getElementById('content-' + fileId);
            const icon = document.getElementById('icon-' + fileId);
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                content.classList.add('collapsed');
                icon.classList.add('collapsed');
            } else {
                content.classList.remove('collapsed');
                content.classList.add('expanded');
                icon.classList.remove('collapsed');
            }
        }

        function expandAll() {
            document.querySelectorAll('.file-content').forEach(content => {
                content.classList.remove('collapsed');
                content.classList.add('expanded');
            });
            document.querySelectorAll('.toggle-icon').forEach(icon => {
                icon.classList.remove('collapsed');
            });
        }

        function collapseAll() {
            document.querySelectorAll('.file-content').forEach(content => {
                content.classList.remove('expanded');
                content.classList.add('collapsed');
            });
            document.querySelectorAll('.toggle-icon').forEach(icon => {
                icon.classList.add('collapsed');
            });
        }

        function download(fileId) {
            window.location.href = '/download/' + fileId;
        }

        function downloadFailReport(fileId) {
            window.location.href = '/download_fail_report/' + fileId;
        }

        function clearFile(fileId) {
            const element = document.getElementById('file-' + fileId);
            if (element) {
                element.remove();
            }
        }

        function copyLog(button, logId) {
            const logElement = document.getElementById(logId);
            const text = logElement.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = 'âœ“ å·²è¤‡è£½';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                alert('è¤‡è£½å¤±æ•—: ' + err);
            });
        }
    </script>
</body>
</html>
